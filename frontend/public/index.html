<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Your Salary In Canada</title>
    <meta name="description" content="See where you stand by comparing your income against Canadian income distribution using Statistics Canada 2021 Census data and household annual survery.">
    <meta name="keywords" content="Canada salary comparison, income percentile, Statistics Canada, census data, wage comparison, Canadian income distribution">
    <link rel="canonical" href="https://compareyoursalary.ca/">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compareyoursalary.ca/">
    <meta property="og:title" content="Compare Your Salary In Canada">
    <meta property="og:description" content="See where you stand by comparing your income against Canadian income distribution using Statistics Canada 2021 Census data and household annual survery.">
    <meta property="og:site_name" content="Income Comparison Canada">
	<meta property="og:image" content="https://compareyoursalary.ca/cover-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Compare Your Salary In Canada">
    <meta name="twitter:description" content="Compare your income against Canadian income distribution using Statistics Canada 2021 Census data.">

    <!-- Language Alternates -->
    <link rel="alternate" hreflang="en" href="https://compareyoursalary.ca/?lang=en">
    <link rel="alternate" hreflang="fr" href="https://compareyoursalary.ca/?lang=fr">
    <link rel="alternate" hreflang="x-default" href="https://compareyoursalary.ca/">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">

    <!-- Preconnect to CDNs for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Income Comparison Canada",
      "description": "Compare your salary against Canadian income distribution using Statistics Canada 2021 Census data",
      "url": "https://compareyoursalary.ca/",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CAD"
      },
      "author": {
        "@type": "Person",
        "name": "Matthieu Guyonnet-Duluc"
      },
      "inLanguage": ["en", "fr"],
      "isAccessibleForFree": true
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f3f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #d52b1e;
        }
        
        button {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            background: #d52b1e;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(213, 43, 30, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .legend-percentile {
            font-weight: 600;
            color: #d52b1e;
            font-size: 0.95em;
        }
        
        .legend-income {
            color: #666;
            font-size: 0.9em;
        }
        
        .comparison-message {
            background: #ffeaea;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .comparison-message p {
            color: #8b1a10;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .comparison-message p:last-child {
            margin-bottom: 0;
        }
        
        .explanation-box {
            background: #f8f9fa;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .explanation-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .explanation-box p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .explanation-box p:last-child {
            margin-bottom: 0;
        }

        .toc-section {
            margin-top: 40px;
            padding: 25px;
            background-color: #f0f4f8;
            border-radius: 10px;
            border-left: 5px solid #d52b1e;
        }

        .toc-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .toc-category {
            margin-bottom: 15px;
        }

        .toc-category-title {
            font-weight: 600;
            color: #d52b1e;
            margin-bottom: 10px;
            font-size: 1.05em;
        }

        .toc-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .toc-list li {
            margin-bottom: 8px;
        }

        .toc-list a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .toc-list a:hover {
            background-color: #fff;
            color: #d52b1e;
            padding-left: 15px;
        }

        .faq-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e0e0e0;
        }
        
        .faq-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .faq-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d52b1e;
        }
        
        .faq-question {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
            margin-bottom: 10px;
        }
        
        .faq-answer {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .changelog {
            margin-top: 40px;
            padding-top: 40px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            border-top: 2px solid #e0e0e0;
        }

        .changelog h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }

        .changelog-entry {
            margin-bottom: 15px;
        }

        .changelog-version {
            font-weight: 600;
            color: #d52b1e;
            margin-bottom: 5px;
        }

        .changelog-date {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .changelog-items {
            margin-top: 8px;
            padding-left: 20px;
        }

        .changelog-items li {
            color: #555;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .contribute-section {
            margin-top: 40px;
            padding-top: 40px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            border-top: 2px solid #e0e0e0;
        }

        .contribute-section h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
        }

        .contribute-section p {
            color: #555;
            line-height: 1.6;
        }

        .contribute-section a {
            color: #d52b1e;
            text-decoration: none;
            font-weight: 600;
        }

        .contribute-section a:hover {
            text-decoration: underline;
        }

        .footer {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            font-size: 0.85em;
            color: #666;
        }

        .footer p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .footer a {
            color: #d52b1e;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: #a32216;
            text-decoration: underline;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f0f0f0;
        }

        .lang-btn.active {
            background: #d52b1e;
            color: white;
        }

        /* Tab Navigation */
        .comparison-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab-btn {
            padding: 14px 28px;
            font-size: 1em;
            font-weight: 600;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn:hover {
            background: #e8e8e8;
            color: #333;
        }

        .tab-btn.active {
            background: #d52b1e;
            color: white;
            border-color: #d52b1e;
            z-index: 1;
        }

        .tab-btn.active:hover {
            background: #c02718;
        }

        .tab-content {
            display: none;
            border: 1px solid #e0e0e0;
            border-top: 2px solid #d52b1e;
            border-radius: 0 8px 8px 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .tab-content .input-section {
            padding: 24px;
            margin: 0;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .language-switcher {
                top: 10px;
                right: 10px;
                padding: 4px;
            }

            .lang-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .comparison-tabs {
                gap: 5px;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-top: 35px;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 0.85em;
                margin-bottom: 20px;
            }
            
            .input-section {
                padding: 20px;
            }
            
            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .input-field {
                width: 100%;
            }
            
            .input-field label {
                font-size: 0.9em;
            }
            
            input {
                padding: 12px 15px;
                font-size: 1em;
                width: 100%;
            }
            
            button {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .comparison-message {
                padding: 15px;
                font-size: 0.95em;
            }
            
            .comparison-message p {
                font-size: 0.95em;
            }
            
            .chart-container {
                height: 300px;
                padding: 15px;
            }
            
            .legend {
                padding: 15px;
            }
            
            .legend-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .legend-percentile {
                font-size: 0.85em;
            }
            
            .legend-income {
                font-size: 0.8em;
            }
            
            .explanation-box {
                padding: 15px;
            }
            
            .explanation-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .explanation-box p {
                font-size: 0.85em;
            }
            
            .faq-section {
                margin-top: 30px;
                padding-top: 30px;
            }
            
            .faq-title {
                font-size: 1.4em;
                margin-bottom: 20px;
            }
            
            .faq-item {
                padding: 15px;
            }
            
            .faq-question {
                font-size: 0.95em;
            }
            
            .faq-answer {
                font-size: 0.85em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .input-section {
                padding: 25px;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="language-switcher">
        <button class="lang-btn active" data-lang="en">English</button>
        <button class="lang-btn" data-lang="fr">Fran√ßais</button>
    </div>

    <div class="container">
        <h1 data-i18n="title">üá®üá¶ Compare Your Salary In Canada </h1>
        <p class="subtitle" data-i18n="subtitle">Compare your income against Canadian income distribution.</p>

        <!-- Comparison Mode Tabs -->
        <div class="comparison-tabs">
            <button class="tab-btn active" data-tab="individual" data-i18n="tab_individual">üíº Individual Salary (2020)</button>
            <button class="tab-btn" data-tab="household" data-i18n="tab_household">üè† Household Income (2024)</button>
        </div>

        <!-- Individual Salary Tab Content -->
        <div class="tab-content active" id="individual-tab">
            <div class="input-section">
                <div class="input-group">
                    <div class="input-wrapper">
                        <div class="input-field">
                            <label for="income" data-i18n="income_label">Your annual wage ($)</label>
                            <input
                                type="number"
                                id="income"
                                data-i18n="[placeholder]income_placeholder"
                                placeholder="65000"
                                min="0"
                                step="1000"
                            >
                        </div>
                        <div class="input-field">
                            <label for="age" data-i18n="age_label">Your age</label>
                            <input
                                type="number"
                                id="age"
                                data-i18n="[placeholder]age_placeholder"
                                placeholder="30"
                                min="15"
                                max="100"
                                step="1"
                            >
                        </div>
                        <button onclick="calculateIndividual()" data-i18n="compare_button">Compare</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Household Income Tab Content -->
        <div class="tab-content" id="household-tab">
            <div class="input-section">
                <div class="input-group">
                    <div class="input-wrapper">
                        <div class="input-field">
                            <label for="household-income" data-i18n="household_income_label">Household annual income ($)</label>
                            <input
                                type="number"
                                id="household-income"
                                data-i18n="[placeholder]household_income_placeholder"
                                placeholder="95000"
                                min="0"
                                step="1000"
                            >
                        </div>
                        <button onclick="calculateHousehold()" data-i18n="compare_button">Compare</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison-message" id="message" style="display: none;"></div>
        
        <div class="results" id="results">
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
            
            <div class="legend">
                <div class="legend-title" data-i18n="legend_title">üìä Income Distribution Percentiles</div>
                <div class="legend-grid" id="legendGrid"></div>
            </div>

            <div class="explanation-box">
                <div class="explanation-title" data-i18n="explanation_title">üí° Understanding Percentiles</div>
                <p data-i18n="[html]percentile_definition"><strong>What is a percentile?</strong> A percentile tells you what percentage of people earn less than a given amount.</p>
                <p id="percentileExample"><strong>Example:</strong> The <strong>25th percentile (P25)</strong> tells you the income level where 25% of people earn less and 75% earn more.</p>
                <p id="medianExample"><strong>The median (P50)</strong> is the middle point where exactly 50% of people earn less and 50% earn more. It's the most common way to describe "typical" income.</p>
            </div>
        </div>

        <div class="toc-section">
            <h2 class="toc-title" data-i18n="toc_title">üìë Table of Contents</h2>
            <div class="toc-grid">
                <div class="toc-category">
                    <div class="toc-category-title" data-i18n="toc_faq_title">Frequently Asked Questions</div>
                    <ul class="toc-list">
                        <li><a href="#faq1" data-i18n="faq1_question">What's the purpose of this website?</a></li>
                        <li><a href="#faq6" data-i18n="faq6_question">What's the difference between Individual Salary and Household Income comparisons?</a></li>
                        <li><a href="#faq2" data-i18n="faq2_question">Where does this data come from?</a></li>
                        <li><a href="#faq3" data-i18n="faq3_question">How current is this data?</a></li>
                        <li><a href="#faq4" data-i18n="faq4_question">What does "wage" include?</a></li>
                        <li><a href="#faq5" data-i18n="faq5_question">What does "household income" include?</a></li>
                        <li><a href="#faq7" data-i18n="faq7_question">What are the current limitations and potential improvements?</a></li>
                    </ul>
                </div>
                <div class="toc-category">
                    <div class="toc-category-title" data-i18n="toc_other_title">Other Sections</div>
                    <ul class="toc-list">
                        <li><a href="#changelog" data-i18n="toc_changelog">Change Log</a></li>
                        <li><a href="#contribute" data-i18n="toc_contribute">Contribute</a></li>
                        <li><a href="#about" data-i18n="toc_about">About</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="faq-section" id="faq">
            <h2 class="faq-title" data-i18n="faq_title">‚ùì Frequently Asked Questions</h2>

            <div class="faq-item" id="faq1">
                <div class="faq-question" data-i18n="faq1_question">What's the purpose of this website?</div>
                <div class="faq-answer" data-i18n="[html]faq1_answer">
                    We often hear about the "average salary" in Canada, but averages can be misleading due to high earners skewing the data. This website aims to provide a clearer picture of income distribution using percentiles, allowing individuals to see how their earnings compare to others in Canada based on reliable census data and annual surveys.
                </div>
            </div>

            <div class="faq-item" id="faq6">
                <div class="faq-question" data-i18n="faq6_question">What's the difference between Individual Salary and Household Income comparisons?</div>
                <div class="faq-answer" data-i18n="[html]faq6_answer">
                    <strong>Individual Salary</strong> compares your personal employment income (wages and salaries) to other individuals in your age group using detailed census percentile data (P10, P25, P50, P75, P90, P95, P99). This is best for understanding where your personal earnings stand. <strong>Household Income</strong> compares the combined income of all people in your household to other Canadian households using quintile data (5 groups of 20% each). This gives a broader picture of your household's economic situation, regardless of how many earners contribute. Note that household data is not age-specific and uses broader income ranges.
                </div>
            </div>

            <div class="faq-item" id="faq2">
                <div class="faq-question" data-i18n="faq2_question">Where does this data come from?</div>
                <div class="faq-answer" data-i18n="[html]faq2_answer">
                    The individual salary data comes from <strong><a href="https://www12.statcan.gc.ca/census-recensement/index-eng.cfm" title="Census website">Statistics Canada's Census of Population 2021</a></strong>, which is the most comprehensive and reliable source for income distribution in Canad (see also their own <a href="https://www12.statcan.gc.ca/census-recensement/2021/dp-pd/dv-vd/income-revenu/index-en.html">income explorer</a>). The census surveys millions of Canadians and provides official government statistics on employment income. The household income data comes from Statistics Canada's annual <strong><a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610058701" title="Household income survey">Household Income Survey (table 36-10-0587-01)</a></strong>.
                </div>
            </div>

            <div class="faq-item" id="faq3">
                <div class="faq-question" data-i18n="faq3_question">How current is this data?</div>
                <div class="faq-answer" data-i18n="[html]faq3_answer">
                    The individual salary data reflects the <strong>2020 calendar year</strong> (collected during the 2021 Census). While this is the most recent comprehensive census data available, please note that income levels and distributions may have changed since 2020 due to inflation, economic growth, and other factors. The website will be updated when the next census data becomes available in 2026-2027. The household income data reflects the <strong>2024 calendar year</strong> (collected during the 2025 survey). This is the most recent annual household income data available from Statistics Canada.
                </div>
            </div>

            <div class="faq-item" id="faq4">
                <div class="faq-question" data-i18n="faq4_question">What does "wage" include?</div>
                <div class="faq-answer" data-i18n="[html]faq4_answer">
                    Gross wages and salaries before deductions for such items as income taxes, pension plan contributions, and employment insurance premiums during the reference period. <a href="https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-eng.cfm?ID=pop128" title="Statistics Canada definition">Source</a>
                </div>
            </div>

            <div class="faq-item" id="faq5">
                <div class="faq-question" data-i18n="faq5_question">What does "household income" include?</div>
                <div class="faq-answer" data-i18n="[html]faq5_answer">
                    It's based on the Household Income Survey (table 36-10-0587-01), which doesn't have the same level of detail as the census income data. To get an approximation of the income as we commonly think of it (i.e., the amount we see in our employment contract before taxes), we added back the "current transfers paid" to the disposable income.
                </div>
            </div>

            <div class="faq-item" id="faq7">
                <div class="faq-question" data-i18n="faq7_question">What are the current limitations and potential improvements ?</div>
                <div class="faq-answer" data-i18n="[html]faq7_answer">
                    The individual salary comparison is based on <strong>employment income (wages and salaries)</strong>, which means it's most relevant for people who are currently employed. If you are a retiree or primarily receive income from sources other than employment (such as pensions, investments, or government transfers), these statistics may not be relevant to your situation. A future version of this tool may address this limitation by including additional income categories.<br><br>Additionally, the individual salary data is from the <strong>2020 calendar year</strong>. A future version may include an option to <strong>inflation-adjust the data</strong> to current dollars, which would provide a more accurate comparison by accounting for changes in purchasing power since 2020.<br><br>If you have suggestions for other improvements, please feel free to <a href="https://matthieugd.com/a-propos/" target="_blank" rel="noopener noreferrer">contact me</a>.
                </div>
            </div>


        </div>

        <div class="changelog" id="changelog">
            <h2 data-i18n="changelog_title">Change Log</h2>
            <div class="changelog-entry">
                <div class="changelog-version">
                    <span data-i18n="changelog_version_1">Version 1.0</span>
                    <span class="changelog-date" data-i18n="changelog_date_1">November, 10th 2025</span>
                </div>
                <ul class="changelog-items">
                    <li data-i18n="changelog_1_item_1">Initial release with individual salary comparison by age group</li>
                    <li data-i18n="changelog_1_item_2">Added household income comparison by quintiles</li>
                    <li data-i18n="changelog_1_item_3">Bilingual support (English and French)</li>
                    <li data-i18n="changelog_1_item_4">Interactive charts with user position indicator</li>
                    <li data-i18n="changelog_1_item_5">Based on Statistics Canada Census 2021 data and table 36-10-0587-01 Distributions of household economic accounts, income, consumption and saving, by characteristic, annual</li>
                </ul>
            </div>
        </div>

        <div class="contribute-section" id="contribute">
            <h2 data-i18n="contribute_title">ü§ù Contribute</h2>
            <p data-i18n="[html]contribute_message">This is a personal project born of my personal interest in the economy. If you have suggestions to improve this website, please feel free to submit a change request on <a href="https://github.com/matthieugd/income-comparison-canada" target="_blank" rel="noopener noreferrer">GitHub</a>.</p>
        </div>

        <div class="footer" id="about">
            <p data-i18n="[html]footer_author">Created by <a href="https://matthieugd.com" target="_blank" rel="noopener noreferrer">Matthieu Guyonnet-Duluc</a>.</p>
            <p data-i18n="[html]footer_thanks">Special thanks to <a href="https://x.com/PhilSmith26" target="_blank" rel="noopener noreferrer">Philip Smith</a> for his invaluable help. Any errors are my own.</p>
            <p data-i18n="[html]footer_contact">Questions or feedback? <a href="https://matthieugd.com/a-propos/" target="_blank" rel="noopener noreferrer">Contact me</a>.</p>
        </div>
    </div>

    <script>
        // ============================================
        // Income Comparison Canada - Main Application
        // ============================================
        // NOTE: For production, minify this script using:
        // - Terser (https://terser.org/) for JavaScript
        // - cssnano for CSS (inline in <style> tag above)
        // - html-minifier for HTML
        // Or use an online tool like: https://www.toptal.com/developers/javascript-minifier
        // ============================================

        // i18next initialization
        const translations = {
            en: {
                translation: {
                    title: "üá®üá¶ Compare Your Salary In Canada",
                    subtitle: "Compare your income against Canadian income distribution.",
                    meta_description: "Compare your salary to Canadian income distribution using Statistics Canada 2021 Census data. Find out where your income stands by age group with detailed percentile analysis.",
                    og_title: "Compare Your Salary In Canada",
                    og_description: "Compare your income against Canadian income distribution using Statistics Canada 2021 Census data. See where you stand by age group.",
                    income_label: "Your annual wage ($)",
                    income_placeholder: "65000",
                    age_label: "Your age",
                    age_placeholder: "30",
                    compare_button: "Compare",
                    legend_title: "üìä Income Distribution Percentiles",
                    household_legend_title: "üìä Household Income Quintiles",
                    explanation_title: "üí° Understanding Percentiles",
                    percentile_definition: "<strong>What is a percentile?</strong> A percentile tells you what percentage of people earn less than a given amount.",
                    percentile_example: "<strong>Example:</strong> The <strong>25th percentile (P25) is ${{p25}}</strong>. This means 25% of Canadians in this age group earn less than ${{p25}}, and 75% earn more.",
                    median_example: "<strong>The median (P50) is ${{p50}}</strong>. This is the middle point where exactly 50% of people earn less and 50% earn more. It's the most common way to describe \"typical\" income.",
                    faq_title: "‚ùì Frequently Asked Questions",
                    faq1_question: "What's the purpose of this website?",
                    faq1_answer: "We often hear about the \"average salary\" in Canada, but averages can be misleading due to high earners skewing the data. This website aims to provide a clearer picture of income distribution using percentiles, allowing individuals to see how their earnings compare to others in Canada based on reliable census data and annual surveys.",
                    faq2_question: "Where does this data come from?",
                    faq2_answer: "The individual salary data comes from <strong><a href=\"https://www12.statcan.gc.ca/census-recensement/index-eng.cfm\" title=\"Census website\">Statistics Canada's Census of Population 2021</a></strong>, which is the most comprehensive and reliable source for income distribution in Canada (see also their own <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/dp-pd/dv-vd/income-revenu/index-en.html\">income explorer</a>). The census surveys millions of Canadians and provides official government statistics on employment income. The household income data comes from Statistics Canada's annual <strong><a href=\"https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610058701\" title=\"Household income survey\">Household Income Survey (table 36-10-0587-01)</a></strong>.",
                    faq3_question: "How current is this data?",
                    faq3_answer: "The individual salary data reflects the <strong>2020 calendar year</strong> (collected during the 2021 Census). While this is the most recent comprehensive census data available, please note that income levels and distributions may have changed since 2020 due to inflation, economic growth, and other factors. The website will be updated when the next census data becomes available in 2026-2027. The household income data reflects the <strong>2024 calendar year</strong> (collected during the 2025 survey). This is the most recent annual household income data available from Statistics Canada.",
                    faq4_question: "What does \"wage\" include?",
                    faq4_answer: "Gross wages and salaries before deductions for such items as income taxes, pension plan contributions, and employment insurance premiums during the reference period. <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-eng.cfm?ID=pop128\" title=\"Statistics Canada definition\">Source</a>",
                    faq5_question: "What does \"household income\" include?",
                    faq5_answer: "It's based on the Household Income Survey (table 36-10-0587-01), which doesn't have the same level of detail as the census income data. To get an approximation of the income as we commonly think of it (i.e., the amount we see in our employment contract before taxes), we added back the \"current transfers paid\" to the disposable income.",
                    percentile_p10: "10th Percentile (P10)",
                    percentile_p25: "25th Percentile (P25)",
                    percentile_p50: "50th Percentile (Median)",
                    percentile_p75: "75th Percentile (P75)",
                    percentile_p90: "90th Percentile (P90)",
                    percentile_p95: "95th Percentile (P95)",
                    percentile_p99: "99th Percentile (P99)",
                    chart_you_label: "YOU",
                    chart_x_axis: "Income Ranges",
                    chart_y_axis: "Percentage of Population (%)",
                    chart_tooltip_canadians: "of Canadians",
                    chart_tooltip_percentile: "Percentile range",
                    result_message_main: "At age {{age}}, you earn more than {{percentile}}% of Canadians with employment income in your age group ({{ageGroup}}).",
                    result_message_more: "You earn ${{diff}} ({{percentDiff}}%) <strong>more</strong> than the median income for your age group (${{median}}).",
                    result_message_less: "You earn ${{diff}} ({{percentDiff}}%) <strong>less</strong> than the median income for your age group (${{median}}).",
                    result_message_exact: "You earn exactly the median income for your age group (${{median}}).",
                    result_message_bracket: "Income bracket: <strong>{{bracket}}</strong>",
                    error_invalid_income: "Please enter a valid income amount",
                    error_invalid_age: "Please enter a valid age (15-100)",
                    error_api_connection: "Error connecting to the backend API. Please make sure the server is running.",
                    tab_individual: "üíº Individual Salary (2020)",
                    tab_household: "üè† Household Income (2024)",
                    household_income_label: "Household annual income ($)",
                    household_income_placeholder: "95000",
                    household_result_message_main: "Your household earns more than around {{percentile}}% of Canadian households.",
                    household_result_message_bracket: "Income bracket: <strong>{{bracket}}</strong>",
                    household_explanation_title: "üí° Understanding Quintiles",
                    household_quintile_definition: "<strong>What is a quintile?</strong> A quintile divides households into 5 equal groups of 20% each, based on income.",
                    household_quintile_example: "<strong>Example:</strong> The <strong>First Quintile (Q1) has an average income of {{q1_avg}}</strong>. This represents the bottom 20% of Canadian households by income.",
                    household_quintile_middle: "<strong>The Third Quintile (Q3) has an average income of {{q3_avg}}</strong>. This represents the middle 20% of households and is often considered \"middle class\" income.",
                    quintile_q1: "First Quintile (Q1) - Bottom 20%",
                    quintile_q2: "Second Quintile (Q2)",
                    quintile_q3: "Third Quintile (Q3) - Middle 20%",
                    quintile_q4: "Fourth Quintile (Q4)",
                    quintile_q5: "Fifth Quintile (Q5) - Top 20%",
                    faq6_question: "What's the difference between Individual Salary and Household Income comparisons?",
                    faq6_answer: "<strong>Individual Salary</strong> compares your personal employment income (wages and salaries) to other individuals in your age group using detailed census percentile data (P10, P25, P50, P75, P90, P95, P99). This is best for understanding where your personal earnings stand.<br><br><strong>Household Income</strong> compares the combined income of all people in your household to other Canadian households using quintile data (5 groups of 20% each). This gives a broader picture of your household's economic situation, regardless of how many earners contribute. Note that household data is not age-specific and uses broader income ranges.",
                    faq7_question: "What are the current limitations and potential improvements?",
                    faq7_answer: "The individual salary comparison is based on <strong>employment income (wages and salaries)</strong>, which means it's most relevant for people who are currently employed. If you are a retiree or primarily receive income from sources other than employment (such as pensions, investments, or government transfers), these statistics may not be relevant to your situation. A future version of this tool may address this limitation by including additional income categories.<br><br>Additionally, the individual salary data is from the <strong>2020 calendar year</strong>. A future version may include an option to <strong>inflation-adjust the data</strong> to current dollars, which would provide a more accurate comparison by accounting for changes in purchasing power since 2020.<br><br>If you have suggestions for other improvements, please feel free to <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">contact me</a>.",
                    toc_title: "üìë Table of Contents",
                    toc_faq_title: "Frequently Asked Questions",
                    toc_other_title: "Other Sections",
                    toc_changelog: "Change Log",
                    toc_contribute: "Contribute",
                    toc_about: "About",
                    changelog_title: "üìã Change Log",
                    changelog_version_1: "Version 1.0",
                    changelog_date_1: "November, 10th 2025",
                    changelog_1_item_1: "Initial release with individual salary comparison by age group",
                    changelog_1_item_2: "Added household income comparison by quintiles",
                    changelog_1_item_3: "Bilingual support (English and French)",
                    changelog_1_item_4: "Interactive charts with user position indicator",
                    changelog_1_item_5: "Based on Statistics Canada Census 2021 data and table 36-10-0587-01 Distributions of household economic accounts, income, consumption and saving, by characteristic, annual",
                    contribute_title: "ü§ù Contribute",
                    contribute_message: "This is a personal project born of my personal interest in the economy. If you have suggestions to improve this website, please feel free to submit a change request on <a href=\"https://github.com/matthieugd/income-comparison-canada\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>.",
                    footer_author: "Created by <a href=\"https://matthieugd.com\" target=\"_blank\" rel=\"noopener noreferrer\">Matthieu Guyonnet-Duluc</a>.",
                    footer_thanks: "Special thanks to <a href=\"https://x.com/PhilSmith26\" target=\"_blank\" rel=\"noopener noreferrer\">Philip Smith</a> for his invaluable help. Any errors are my own.",
                    footer_contact: "Questions or feedback? <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">Contact me</a>."
                }
            },
            fr: {
                translation: {
                    title: "üá®üá¶ Comparez Votre Salaire au Canada",
                    subtitle: "Comparez votre salaire avec la distribution des revenus canadiens.",
                    meta_description: "Comparez votre salaire √† la distribution des revenus canadiens en utilisant les donn√©es du recensement 2021 de Statistique Canada. D√©couvrez o√π se situe votre revenu par groupe d'√¢ge avec une analyse d√©taill√©e des percentiles.",
                    og_title: "Comparez Votre Salaire au Canada",
                    og_description: "Comparez votre revenu √† la distribution des revenus canadiens en utilisant les donn√©es du recensement 2021 de Statistique Canada. D√©couvrez o√π vous vous situez par groupe d'√¢ge.",
                    income_label: "Votre salaire annuel ($)",
                    income_placeholder: "65000",
                    age_label: "Votre √¢ge",
                    age_placeholder: "30",
                    compare_button: "Comparer",
                    legend_title: "üìä Percentiles de Distribution des Revenus",
                    household_legend_title: "üìä Quintiles de Revenu des M√©nages",
                    explanation_title: "üí° Comprendre les Percentiles",
                    percentile_definition: "<strong>Qu'est-ce qu'un percentile?</strong> Un percentile indique le pourcentage de personnes gagnant moins qu'un montant donn√©.",
                    percentile_example: "<strong>Exemple:</strong> Le <strong>25e percentile (P25) est de {{p25}} $</strong>. Cela signifie que 25 % des Canadiens de ce groupe d'√¢ge gagnent moins de {{p25}} $ et 75 % gagnent plus.",
                    median_example: "<strong>La m√©diane (P50) est de {{p50}} $</strong>. C'est le point m√©dian o√π exactement 50 % des personnes gagnent moins et 50 % gagnent plus. C'est la fa√ßon la plus courante de d√©crire le revenu \"typique\".",
                    faq_title: "‚ùì Questions Fr√©quemment Pos√©es",
                    faq1_question: "Quel est le but de ce site web?",
                    faq1_answer: "On entend souvent parler du \"salaire moyen\" au Canada, mais les moyennes peuvent √™tre trompeuses en raison des hauts salaires qui faussent les donn√©es. Ce site vise √† fournir une image plus claire de la distribution des revenus en utilisant les percentiles, permettant aux individus de voir comment leurs gains se comparent aux autres au Canada selon des donn√©es de recensement fiables et des enqu√™tes annuelles.",
                    faq2_question: "D'o√π proviennent ces donn√©es?",
                    faq2_answer: "Les donn√©es de salaire individuel proviennent du <strong><a href=\"https://www12.statcan.gc.ca/census-recensement/index-fra.cfm\" title=\"Site du recensement\">Recensement de la population 2021 de Statistique Canada</a></strong>, qui est la source la plus compl√®te et fiable pour la distribution des revenus au Canada (voir leur prorpre version de <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/dp-pd/dv-vd/income-revenu/index-fr.html\">l'explorateur du revenu</a>). Le recensement interroge des millions de Canadiens et fournit des statistiques gouvernementales officielles sur les revenus d'emploi. Les donn√©es de revenu des m√©nages proviennent de l'<strong><a href=\"https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=3610058701\" title=\"Enqu√™te sur le revenu des m√©nages\">Enqu√™te annuelle sur le revenu des m√©nages de Statistique Canada (tableau 36-10-0587-01)</a></strong>.",
                    faq3_question: "√Ä quel point ces donn√©es sont-elles r√©centes?",
                    faq3_answer: "Les donn√©es de salaire individuel refl√®tent l'<strong>ann√©e civile 2020</strong> (collect√©es lors du recensement de 2021). Bien qu'il s'agisse des donn√©es de recensement compl√®tes les plus r√©centes disponibles, veuillez noter que les niveaux de revenus et les distributions peuvent avoir chang√© depuis 2020 en raison de l'inflation, de la croissance √©conomique et d'autres facteurs. Le site sera mis √† jour lorsque les prochaines donn√©es de recensement seront disponibles en 2026-2027. Les donn√©es de revenu des m√©nages refl√®tent l'<strong>ann√©e civile 2024</strong> (collect√©es lors de l'enqu√™te de 2025). Il s'agit des donn√©es annuelles les plus r√©centes disponibles de Statistique Canada sur le revenu des m√©nages.",
                    faq4_question: "Que comprend le \"salaire\"?",
                    faq4_answer: "Les salaires et traitements bruts avant les retenues pour les imp√¥ts sur le revenu, les cotisations √† un r√©gime de pension et au programme d'assurance-emploi au cours de la p√©riode de r√©f√©rence. <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-fra.cfm?ID=pop128\" title=\"D√©finition de Statistique Canada\">Source</a>",
                    faq5_question: "Que comprend le \"revenu des m√©nages\"?",
                    faq5_answer: "Il est bas√© sur l'Enqu√™te sur le revenu des m√©nages (tableau 36-10-0587-01), qui ne pr√©sente pas le m√™me niveau de d√©tail que les donn√©es de revenu du recensement. Pour obtenir une approximation du revenu tel que nous le concevons couramment (c'est-√†-dire le montant que nous voyons dans notre contrat de travail avant les imp√¥ts), nous avons ajout√© les \"transferts courants vers√©s\" au revenu disponible.",
                    percentile_p10: "10e Percentile (P10)",
                    percentile_p25: "25e Percentile (P25)",
                    percentile_p50: "50e Percentile (M√©diane)",
                    percentile_p75: "75e Percentile (P75)",
                    percentile_p90: "90e Percentile (P90)",
                    percentile_p95: "95e Percentile (P95)",
                    percentile_p99: "99e Percentile (P99)",
                    chart_you_label: "VOUS",
                    chart_x_axis: "Tranches de Revenu",
                    chart_y_axis: "Pourcentages de la Population (%)",
                    chart_tooltip_canadians: "des Canadiens",
                    chart_tooltip_percentile: "Plage de percentile",
                    result_message_main: "√Ä {{age}} ans, vous gagnez plus que {{percentile}} % des Canadiens ayant un revenu d'emploi dans votre groupe d'√¢ge ({{ageGroup}}).",
                    result_message_more: "Vous gagnez {{diff}} $ ({{percentDiff}} %) de <strong>plus</strong> que le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_less: "Vous gagnez {{diff}} $ ({{percentDiff}} %) de <strong>moins</strong> que le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_exact: "Vous gagnez exactement le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_bracket: "Tranche de revenu : <strong>{{bracket}}</strong>",
                    error_invalid_income: "Veuillez entrer un montant de revenu valide",
                    error_invalid_age: "Veuillez entrer un √¢ge valide (15-100)",
                    error_api_connection: "Erreur de connexion √† l'API backend. Veuillez vous assurer que le serveur fonctionne.",
                    tab_individual: "üíº Salaire Individuel (2020)",
                    tab_household: "üè† Revenu du M√©nage (2024)",
                    household_income_label: "Revenu annuel du m√©nage ($)",
                    household_income_placeholder: "95000",
                    household_result_message_main: "Votre m√©nage gagne plus qu'environ {{percentile}} % des m√©nages canadiens.",
                    household_result_message_bracket: "Tranche de revenu : <strong>{{bracket}}</strong>",
                    household_explanation_title: "üí° Comprendre les Quintiles",
                    household_quintile_definition: "<strong>Qu'est-ce qu'un quintile?</strong> Un quintile divise les m√©nages en 5 groupes √©gaux de 20 % chacun, selon leur revenu.",
                    household_quintile_example: "<strong>Exemple:</strong> Le <strong>Premier Quintile (Q1) a un revenu moyen de {{q1_avg}}</strong>. Cela repr√©sente les 20 % des m√©nages canadiens ayant les revenus les plus faibles.",
                    household_quintile_middle: "<strong>Le Troisi√®me Quintile (Q3) a un revenu moyen de {{q3_avg}}</strong>. Cela repr√©sente les 20 % des m√©nages au milieu et est souvent consid√©r√© comme le revenu de la \"classe moyenne\".",
                    quintile_q1: "Premier Quintile (Q1) - 20 % Inf√©rieur",
                    quintile_q2: "Deuxi√®me Quintile (Q2)",
                    quintile_q3: "Troisi√®me Quintile (Q3) - 20 % Moyen",
                    quintile_q4: "Quatri√®me Quintile (Q4)",
                    quintile_q5: "Cinqui√®me Quintile (Q5) - 20 % Sup√©rieur",
                    faq6_question: "Quelle est la diff√©rence entre les comparaisons de Salaire Individuel et de Revenu du M√©nage?",
                    faq6_answer: "<strong>Salaire Individuel</strong> compare votre revenu d'emploi personnel (salaires et traitements) √† d'autres individus de votre groupe d'√¢ge en utilisant des donn√©es de percentiles d√©taill√©es du recensement (P10, P25, P50, P75, P90, P95, P99). C'est id√©al pour comprendre o√π se situent vos gains personnels. <strong>Revenu du M√©nage</strong> compare le revenu combin√© de toutes les personnes de votre m√©nage √† d'autres m√©nages canadiens en utilisant des donn√©es de quintiles (5 groupes de 20 % chacun). Cela donne une image plus large de la situation √©conomique de votre m√©nage, peu importe le nombre de personnes qui contribuent. Notez que les donn√©es des m√©nages ne sont pas sp√©cifiques √† l'√¢ge et utilisent des fourchettes de revenus plus larges.",
                    faq7_question: "Quelles sont les limitations actuelles et am√©liorations futures?",
                    faq7_answer: "La comparaison de salaire individuel est bas√©e sur le <strong>revenu d'emploi (salaires et traitements)</strong>, ce qui signifie qu'elle est plus pertinente pour les personnes actuellement employ√©es. Si vous √™tes retrait√© ou recevez principalement des revenus de sources autres que l'emploi (comme des pensions, des investissements ou des transferts gouvernementaux), ces statistiques peuvent ne pas √™tre pertinentes pour votre situation. Une future version de cet outil pourrait rem√©dier √† cette limitation en incluant des cat√©gories de revenus suppl√©mentaires.<br><br>De plus, les donn√©es de salaire individuel proviennent de l'<strong>ann√©e civile 2020</strong>. Une future version pourrait inclure une option pour <strong>ajuster les donn√©es en fonction de l'inflation</strong> pour les convertir en dollars actuels, ce qui permettrait une comparaison plus pr√©cise en tenant compte des changements du pouvoir d'achat depuis 2020.<br><br>Si vous avez des suggestions pour d'autres am√©liorations, n'h√©sitez pas √† me <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">contacter</a>.",
                    toc_title: "üìë Table des Mati√®res",
                    toc_faq_title: "Questions Fr√©quemment Pos√©es",
                    toc_other_title: "Autres Sections",
                    toc_changelog: "Journal des Modifications",
                    toc_contribute: "Contribuer",
                    toc_about: "√Ä Propos",
                    changelog_title: "üìã Journal des Modifications",
                    changelog_version_1: "Version 1.0",
                    changelog_date_1: "10 Novembre 2025",
                    changelog_1_item_1: "Version initiale avec comparaison de salaire individuel par groupe d'√¢ge",
                    changelog_1_item_2: "Ajout de la comparaison du revenu du m√©nage par quintiles",
                    changelog_1_item_3: "Support bilingue (fran√ßais et anglais)",
                    changelog_1_item_4: "Graphiques interactifs avec indicateur de position de l'utilisateur",
                    changelog_1_item_5: "Bas√© sur les donn√©es du Recensement de 2021 de Statistique Canada et le tableau 36-10-0587-01 Comptes √©conomiques r√©partis pour le secteur des m√©nages, revenu, consommation et √©pargne, par caract√©ristique, annuel",
                    contribute_title: "ü§ù Contribuer",
                    contribute_message: "Ceci est un projet personnel n√© de mon int√©r√™t personnel pour l'√©conomie. Si vous avez des suggestions pour am√©liorer ce site web, n'h√©sitez pas √† soumettre une demande de modification sur <a href=\"https://github.com/matthieugd/income-comparison-canada\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub</a>.",
                    footer_author: "Cr√©√© par <a href=\"https://matthieugd.com\" target=\"_blank\" rel=\"noopener noreferrer\">Matthieu Guyonnet-Duluc</a>.",
                    footer_thanks: "Remerciements sp√©ciaux √† <a href=\"https://x.com/PhilSmith26\" target=\"_blank\" rel=\"noopener noreferrer\">Philip Smith</a> pour son aide pr√©cieuse. Toutes les erreurs sont les miennes.",
                    footer_contact: "Questions ou commentaires? <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">Contactez-moi</a>."
                }
            }
        };

        // Initialize i18next
        i18next.init({
            lng: 'en',
            fallbackLng: 'en',
            resources: translations,
            interpolation: {
                escapeValue: false
            }
        });

        let chart = null;
        let currentLanguage = 'en';

        // ============================================
        // DATA CACHE & STATIC FILE MANAGEMENT
        // ============================================

        class DataCache {
            constructor() {
                this.memoryCache = {};
                this.manifest = null;
                this.manifestLoaded = false;
            }

            async getManifest() {
                if (this.manifestLoaded) {
                    return this.manifest;
                }

                try {
                    const response = await fetch('data/manifest.json');
                    this.manifest = await response.json();
                    this.manifestLoaded = true;

                    // Check localStorage version
                    const storedVersion = localStorage.getItem('data_version');
                    if (storedVersion !== this.manifest.version) {
                        // Version mismatch, clear old cache
                        this.clearLocalStorage();
                        localStorage.setItem('data_version', this.manifest.version);
                    }

                    return this.manifest;
                } catch (error) {
                    console.error('Failed to load manifest:', error);
                    return null;
                }
            }

            async getData(filename) {
                // Check memory cache first
                if (this.memoryCache[filename]) {
                    return this.memoryCache[filename];
                }

                // Check localStorage
                try {
                    const cached = localStorage.getItem(`data_${filename}`);
                    if (cached) {
                        const data = JSON.parse(cached);
                        this.memoryCache[filename] = data;
                        return data;
                    }
                } catch (error) {
                    console.warn('localStorage read failed:', error);
                }

                // Fetch from server
                try {
                    const response = await fetch(`data/census-2021/${filename}.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // Store in memory cache
                    this.memoryCache[filename] = data;

                    // Store in localStorage
                    try {
                        localStorage.setItem(`data_${filename}`, JSON.stringify(data));
                    } catch (error) {
                        console.warn('localStorage write failed:', error);
                    }

                    return data;
                } catch (error) {
                    console.error(`Failed to load ${filename}:`, error);
                    throw error;
                }
            }

            clearLocalStorage() {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('data_')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            }
        }

        // Initialize cache
        const dataCache = new DataCache();

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function getAgeDemographic(age) {
            if (age >= 15 && age <= 19) return 'age-15-19';
            if (age >= 20 && age <= 24) return 'age-20-24';
            if (age >= 25 && age <= 29) return 'age-25-29';
            if (age >= 30 && age <= 34) return 'age-30-34';
            if (age >= 35 && age <= 39) return 'age-35-39';
            if (age >= 40 && age <= 44) return 'age-40-44';
            if (age >= 45 && age <= 49) return 'age-45-49';
            if (age >= 50 && age <= 54) return 'age-50-54';
            if (age >= 55 && age <= 59) return 'age-55-59';
            if (age >= 60 && age <= 64) return 'age-60-64';
            if (age >= 65) return 'age-65plus';
            return 'all';
        }

        function getAgeGroupLabel(age) {
            if (age >= 15 && age <= 19) return '15-19';
            if (age >= 20 && age <= 24) return '20-24';
            if (age >= 25 && age <= 29) return '25-29';
            if (age >= 30 && age <= 34) return '30-34';
            if (age >= 35 && age <= 39) return '35-39';
            if (age >= 40 && age <= 44) return '40-44';
            if (age >= 45 && age <= 49) return '45-49';
            if (age >= 50 && age <= 54) return '50-54';
            if (age >= 55 && age <= 59) return '55-59';
            if (age >= 60 && age <= 64) return '60-64';
            if (age >= 65) return '65+';
            return null;
        }

        function getDataFilename(age) {
            return `income-canada-${getAgeDemographic(age)}`;
        }

        // ============================================
        // CALCULATION FUNCTIONS (Ported from backend)
        // ============================================

        function calculatePercentile(income, distribution) {
            if (!distribution || !distribution.percentiles) {
                throw new Error('Invalid distribution data');
            }

            const percentiles = [
                [0, 0],
                [10, distribution.percentiles.p10],
                [25, distribution.percentiles.p25],
                [50, distribution.percentiles.p50],
                [75, distribution.percentiles.p75],
                [90, distribution.percentiles.p90],
                [95, distribution.percentiles.p95],
                [99, distribution.percentiles.p99],
                [100, 300000] // Approximate upper bound
            ];

            // Handle edge case: income at or below 10th percentile
            if (income <= percentiles[1][1]) {
                return Math.max(0, (income / percentiles[1][1]) * 10);
            }

            // Handle edge case: income above 99th percentile
            if (income >= percentiles[percentiles.length - 2][1]) {
                return Math.min(99.9, 99 + (income - percentiles[percentiles.length - 2][1]) / percentiles[percentiles.length - 2][1]);
            }

            // Find bracketing percentiles and interpolate
            for (let i = 1; i < percentiles.length - 1; i++) {
                const [pLow, incomeLow] = percentiles[i];
                const [pHigh, incomeHigh] = percentiles[i + 1];

                if (income >= incomeLow && income <= incomeHigh) {
                    const ratio = (income - incomeLow) / (incomeHigh - incomeLow);
                    return pLow + ratio * (pHigh - pLow);
                }
            }

            return 50; // Default to median if calculation fails
        }

        function getIncomeBracket(percentile) {
            if (percentile >= 99) return 'Top 1%';
            if (percentile >= 95) return 'Top 5%';
            if (percentile >= 90) return 'Top 10%';
            if (percentile >= 75) return 'Top 25%';
            if (percentile >= 50) return 'Above Median';
            if (percentile >= 25) return 'Below Median';
            return 'Bottom 25%';
        }

        function calculateHouseholdQuintile(income, quintiles) {
            // Use the same interpolation-based approach as calculateHouseholdPercentile
            // to ensure consistency between percentile and quintile assignment
            const percentile = calculateHouseholdPercentile(income, quintiles);

            // Map percentile to quintile using standard boundaries
            // 0 <= percentile <= 20: Q1 (bottom 20%)
            // 20 < percentile <= 40: Q2 (20-40%)
            // 40 < percentile <= 60: Q3 (40-60%)
            // 60 < percentile <= 80: Q4 (60-80%)
            // 80 < percentile <= 100: Q5 (top 20%)
            let quintileIndex;
            if (percentile <= 20) {
                quintileIndex = 0; // Q1
            } else if (percentile <= 40) {
                quintileIndex = 1; // Q2
            } else if (percentile <= 60) {
                quintileIndex = 2; // Q3
            } else if (percentile <= 80) {
                quintileIndex = 3; // Q4
            } else {
                quintileIndex = 4; // Q5
            }

            const quintileKeys = ['q1', 'q2', 'q3', 'q4', 'q5'];
            const key = quintileKeys[quintileIndex];

            return {
                quintile: quintileIndex + 1,
                label: quintiles[key].label,
                average: quintiles[key].average
            };
        }

        function calculateHouseholdPercentile(income, quintiles) {
            const averages = [
                quintiles.q1.average,
                quintiles.q2.average,
                quintiles.q3.average,
                quintiles.q4.average,
                quintiles.q5.average
            ];

            // Quintile averages represent the MIDDLE of each quintile (10th, 30th, 50th, 70th, 90th percentiles)
            // Calculate boundaries as midpoints between consecutive averages
            const boundaries = [];
            for (let i = 0; i < averages.length - 1; i++) {
                boundaries.push((averages[i] + averages[i + 1]) / 2);
            }
            // boundaries[0] = Q1/Q2 boundary (20th percentile)
            // boundaries[1] = Q2/Q3 boundary (40th percentile)
            // boundaries[2] = Q3/Q4 boundary (60th percentile)
            // boundaries[3] = Q4/Q5 boundary (80th percentile)

            // Define reference points for interpolation:
            // - Start of Q1: income=0 at 0th percentile
            // - Q1 average: at 10th percentile
            // - Q1/Q2 boundary: at 20th percentile
            // - Q2 average: at 30th percentile
            // - Q2/Q3 boundary: at 40th percentile
            // - ... and so on

            // Handle Q1 (0-20th percentile)
            if (income <= boundaries[0]) {
                if (income <= averages[0]) {
                    // Between $0 and Q1 average: 0 to 10th percentile
                    return (income / averages[0]) * 10;
                } else {
                    // Between Q1 average and Q1/Q2 boundary: 10th to 20th percentile
                    const ratio = (income - averages[0]) / (boundaries[0] - averages[0]);
                    return 10 + ratio * 10;
                }
            }

            // Handle Q2 (20-40th percentile)
            if (income <= boundaries[1]) {
                if (income <= averages[1]) {
                    // Between Q1/Q2 boundary and Q2 average: 20th to 30th percentile
                    const ratio = (income - boundaries[0]) / (averages[1] - boundaries[0]);
                    return 20 + ratio * 10;
                } else {
                    // Between Q2 average and Q2/Q3 boundary: 30th to 40th percentile
                    const ratio = (income - averages[1]) / (boundaries[1] - averages[1]);
                    return 30 + ratio * 10;
                }
            }

            // Handle Q3 (40-60th percentile)
            if (income <= boundaries[2]) {
                if (income <= averages[2]) {
                    // Between Q2/Q3 boundary and Q3 average: 40th to 50th percentile
                    const ratio = (income - boundaries[1]) / (averages[2] - boundaries[1]);
                    return 40 + ratio * 10;
                } else {
                    // Between Q3 average and Q3/Q4 boundary: 50th to 60th percentile
                    const ratio = (income - averages[2]) / (boundaries[2] - averages[2]);
                    return 50 + ratio * 10;
                }
            }

            // Handle Q4 (60-80th percentile)
            if (income <= boundaries[3]) {
                if (income <= averages[3]) {
                    // Between Q3/Q4 boundary and Q4 average: 60th to 70th percentile
                    const ratio = (income - boundaries[2]) / (averages[3] - boundaries[2]);
                    return 60 + ratio * 10;
                } else {
                    // Between Q4 average and Q4/Q5 boundary: 70th to 80th percentile
                    const ratio = (income - averages[3]) / (boundaries[3] - averages[3]);
                    return 70 + ratio * 10;
                }
            }

            // Handle Q5 (80-100th percentile)
            if (income <= averages[4]) {
                // Between Q4/Q5 boundary and Q5 average: 80th to 90th percentile
                const ratio = (income - boundaries[3]) / (averages[4] - boundaries[3]);
                return 80 + ratio * 10;
            } else {
                // Above Q5 average: 90th to 99.9th percentile
                // Extrapolate with diminishing returns
                const ratio = income / averages[4];
                return Math.min(99.9, 90 + (ratio - 1) * 15);
            }
        }

        function getHouseholdBracket(quintile) {
            const brackets = {
                1: 'First Quintile (Q1) - Bottom 20%',
                2: 'Second Quintile (Q2)',
                3: 'Third Quintile (Q3) - Middle 20%',
                4: 'Fourth Quintile (Q4)',
                5: 'Fifth Quintile (Q5) - Top 20%'
            };
            return brackets[quintile] || 'Unknown';
        }

        // Translation helper function
        function updatePageTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');

                // Handle different attribute types
                if (key.startsWith('[html]')) {
                    const actualKey = key.replace('[html]', '');
                    element.innerHTML = i18next.t(actualKey);
                } else if (key.startsWith('[placeholder]')) {
                    const actualKey = key.replace('[placeholder]', '');
                    element.placeholder = i18next.t(actualKey);
                } else {
                    element.textContent = i18next.t(key);
                }
            });

            // Update document title and HTML lang attribute using the same translation as h1
            document.documentElement.lang = currentLanguage;
            document.title = i18next.t('title');

            // Update SEO meta tags
            document.querySelector('meta[name="description"]').setAttribute('content', i18next.t('meta_description'));
            document.querySelector('meta[property="og:title"]').setAttribute('content', i18next.t('og_title'));
            document.querySelector('meta[property="og:description"]').setAttribute('content', i18next.t('og_description'));
            document.querySelector('meta[name="twitter:title"]').setAttribute('content', i18next.t('og_title'));
            document.querySelector('meta[name="twitter:description"]').setAttribute('content', i18next.t('og_description'));
        }

        // Language switcher function
        function switchLanguage(lang) {
            currentLanguage = lang;
            i18next.changeLanguage(lang).then(() => {
                updatePageTranslations();

                // Update active button state
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
                });

                // Update URL parameter
                const url = new URL(window.location.href);
                url.searchParams.set('lang', lang);

                // Preserve mode parameter
                if (currentMode) {
                    url.searchParams.set('mode', currentMode);
                }

                window.history.pushState({}, '', url);

                // Re-render chart and results if they're visible
                if (document.getElementById('results').classList.contains('show')) {
                    if (currentMode === 'individual') {
                        const income = parseFloat(document.getElementById('income').value);
                        const age = parseInt(document.getElementById('age').value);
                        if (!isNaN(income) && !isNaN(age)) {
                            calculateIndividual();
                        }
                    } else if (currentMode === 'household') {
                        const income = parseFloat(document.getElementById('household-income').value);
                        if (!isNaN(income)) {
                            calculateHousehold();
                        }
                    }
                }
            });
        }

        // Tab switching functionality
        let currentMode = 'individual'; // 'individual' or 'household'

        function switchTab(mode, preserveData = false) {
            currentMode = mode;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === mode);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${mode}-tab`).classList.add('active');

            // Update URL parameters
            const url = new URL(window.location.href);
            url.searchParams.set('mode', mode);

            // Remove all income-related parameters when switching tabs (unless preserving data)
            if (!preserveData) {
                url.searchParams.delete('income');
                url.searchParams.delete('age');
                url.searchParams.delete('household-income');

                // Hide results when switching tabs
                document.getElementById('results').classList.remove('show');
                document.getElementById('message').style.display = 'none';
            }

            window.history.pushState({}, '', url);

            // Track tab switch in GoatCounter (if enabled)
            if (window.goatcounter && window.goatcounter.count) {
                window.goatcounter.count({
                    path: url.pathname + url.search + url.hash,
                    title: mode === 'individual' ? 'Individual Salary' : 'Household Income',
                    event: true  // Mark as an event rather than a pageview
                });
            }
        }

        // Initialize language switcher buttons and tab switching
        document.addEventListener('DOMContentLoaded', function() {
            // Language switcher
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchLanguage(this.getAttribute('data-lang'));
                });
            });

            // Tab switcher
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });

            // Check for language parameter first
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'en' || langParam === 'fr')) {
                switchLanguage(langParam);
            } else {
                // Detect browser language
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('fr')) {
                    switchLanguage('fr');
                } else {
                    updatePageTranslations();
                }
            }

            // Load data from URL (this will handle mode switching and data loading)
            loadFromURL();
        });

        function generateDistributionData(percentiles) {
            // Create income brackets with the number of people in each bracket
            // Based on percentile data, we can calculate approximate distributions
            const p10 = percentiles.p10;
            const p25 = percentiles.p25;
            const p50 = percentiles.p50;
            const p75 = percentiles.p75;
            const p90 = percentiles.p90;
            const p95 = percentiles.p95;
            const p99 = percentiles.p99;

            const brackets = [
                { min: 0, max: p10, midpoint: p10/2, percentage: 10, label: `$0-$${Math.round(p10/1000)}K`, percentileLabel: '10%' },
                { min: p10, max: p25, midpoint: (p10+p25)/2, percentage: 15, label: `$${Math.round(p10/1000)}K-$${Math.round(p25/1000)}K`, percentileLabel: '25%' },
                { min: p25, max: p50, midpoint: (p25+p50)/2, percentage: 25, label: `$${Math.round(p25/1000)}K-$${Math.round(p50/1000)}K`, percentileLabel: '50%' },
                { min: p50, max: p75, midpoint: (p50+p75)/2, percentage: 25, label: `$${Math.round(p50/1000)}K-$${Math.round(p75/1000)}K`, percentileLabel: '75%' },
                { min: p75, max: p90, midpoint: (p75+p90)/2, percentage: 15, label: `$${Math.round(p75/1000)}K-$${Math.round(p90/1000)}K`, percentileLabel: '90%' },
                { min: p90, max: p95, midpoint: (p90+p95)/2, percentage: 5, label: `$${Math.round(p90/1000)}K-$${Math.round(p95/1000)}K`, percentileLabel: '95%' },
                { min: p95, max: p99, midpoint: (p95+p99)/2, percentage: 4, label: `$${Math.round(p95/1000)}K-$${Math.round(p99/1000)}K`, percentileLabel: '99%' },
                { min: p99, max: p99 * 1.5, midpoint: p99 * 1.25, percentage: 1, label: `$${Math.round(p99/1000)}K+`, percentileLabel: '100%' }
            ];

            return brackets;
        }

        function getXPositionForIncome(income, brackets, quintiles = null) {
            // Find which bracket the income falls into
            let bracketIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (income >= brackets[i].min && income <= brackets[i].max) {
                    bracketIndex = i;
                    break;
                }
            }
            if (bracketIndex === -1 && income >= brackets[brackets.length - 1].max) {
                bracketIndex = brackets.length - 1;
            }

            if (bracketIndex === -1) return 0;

            let positionInBracket;

            if (quintiles) {
                // For HOUSEHOLD income: use percentile-based positioning
                // This ensures consistent positioning regardless of income range width
                // Each quintile spans 20 percentile points (Q1: 0-20, Q2: 20-40, etc.)
                const percentile = calculateHouseholdPercentile(income, quintiles);
                const quintileStartPercentile = bracketIndex * 20;

                // Position within quintile (0 = left edge, 0.5 = middle, 1 = right edge)
                positionInBracket = (percentile - quintileStartPercentile) / 20;
            } else {
                // For INDIVIDUAL income: use dollar-based positioning
                // (Individual chart brackets are already evenly distributed by percentile)
                const bracket = brackets[bracketIndex];
                const range = bracket.max - bracket.min;
                positionInBracket = range > 0 ? (income - bracket.min) / range : 0.5;
            }

            // For bar charts with default settings (barPercentage=0.9, categoryPercentage=0.8)
            // Actual bar width = 0.9 √ó 0.8 = 0.72
            // Bars are centered at integer positions, so bar at index i spans from (i - 0.36) to (i + 0.36)
            const barWidth = 0.72;
            const halfBarWidth = barWidth / 2;

            // Map position within bracket to position within the bar (not the gap)
            return bracketIndex - halfBarWidth + (positionInBracket * barWidth);
        }

        function createChart(userIncome, percentiles) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const brackets = generateDistributionData(percentiles);

            // Find which bracket the user falls into
            let userBracketIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (userIncome >= brackets[i].min && userIncome < brackets[i].max) {
                    userBracketIndex = i;
                    break;
                }
            }
            if (userBracketIndex === -1 && userIncome >= brackets[brackets.length - 1].max) {
                userBracketIndex = brackets.length - 1;
            }
            
            // Create colors - highlight brackets below user's income
            const backgroundColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(180, 180, 180, 0.6)'; // Grey for below user
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 0.8)'; // Red for user's bracket
                } else {
                    return 'rgba(220, 220, 220, 0.5)'; // Light grey for above user
                }
            });

            const borderColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(140, 140, 140, 1)';
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 1)';
                } else {
                    return 'rgba(180, 180, 180, 0.8)';
                }
            });
            
            // Create percentile markers
            const percentileAnnotations = {};

            // Add user income line
            const userXPosition = getXPositionForIncome(userIncome, brackets);
            percentileAnnotations.userIncomeLine = {
                type: 'line',
                xMin: userXPosition,
                xMax: userXPosition,
                borderColor: 'rgba(213, 43, 30, 0.9)',
                borderWidth: 4,
                label: {
                    display: true,
                    content: `${i18next.t('chart_you_label')}: $${userIncome.toLocaleString()}`,
                    position: 'start',
                    backgroundColor: 'rgba(213, 43, 30, 0.9)',
                    color: 'white',
                    font: {
                        size: 11,
                        weight: 'bold'
                    },
                    padding: 6,
                    yAdjust: 10
                }
            };

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brackets.map(b => b.label),
                    datasets: [{
                        label: 'Percentage of Population',
                        data: brackets.map(b => b.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bracket = brackets[context.dataIndex];
                                    return [
                                        `${context.parsed.y}% ${i18next.t('chart_tooltip_canadians')}`,
                                        `${i18next.t('chart_tooltip_percentile')}: ${bracket.percentileLabel}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: percentileAnnotations
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                return brackets[context.dataIndex].percentileLabel;
                            },
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            padding: 4
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: i18next.t('chart_x_axis'),
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: i18next.t('chart_y_axis'),
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            max: 30,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function updateLegend(percentiles) {
            const legendGrid = document.getElementById('legendGrid');

            // Restore legend title for individual mode
            document.querySelector('.legend-title').innerHTML =
                i18next.t('legend_title');

            const percentileLabels = [
                { key: 'percentile_p10', value: percentiles.p10 },
                { key: 'percentile_p25', value: percentiles.p25 },
                { key: 'percentile_p50', value: percentiles.p50 },
                { key: 'percentile_p75', value: percentiles.p75 },
                { key: 'percentile_p90', value: percentiles.p90 },
                { key: 'percentile_p95', value: percentiles.p95 },
                { key: 'percentile_p99', value: percentiles.p99 }
            ];

            legendGrid.innerHTML = percentileLabels.map(item => `
                <div class="legend-item">
                    <div class="legend-percentile">${i18next.t(item.key)}</div>
                    <div class="legend-income">$${item.value.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function updatePercentileExamples(percentiles) {
            const p25 = percentiles.p25.toLocaleString();
            const p50 = percentiles.p50.toLocaleString();

            // Restore explanation title for individual mode
            document.querySelector('.explanation-title').innerHTML =
                i18next.t('explanation_title');

            // Restore definition for individual mode
            document.querySelector('.explanation-box p:nth-child(2)').innerHTML =
                i18next.t('percentile_definition');

            // Update examples with percentile values
            document.getElementById('percentileExample').innerHTML =
                i18next.t('percentile_example', { p25: p25 });

            document.getElementById('medianExample').innerHTML =
                i18next.t('median_example', { p50: p50 });
        }

        function updateQuintileExamples(quintiles) {
            const q1_avg = '$' + quintiles.q1.average.toLocaleString();
            const q2_avg = '$' + quintiles.q2.average.toLocaleString();
            const q3_avg = '$' + quintiles.q3.average.toLocaleString();
            const q4_avg = '$' + quintiles.q4.average.toLocaleString();
            const q5_avg = '$' + quintiles.q5.average.toLocaleString();

            // Update legend title
            document.querySelector('.legend-title').innerHTML =
                i18next.t('household_legend_title');

            // Update explanation title
            document.querySelector('.explanation-title').innerHTML =
                i18next.t('household_explanation_title');

            // Update definition
            document.querySelector('.explanation-box p:nth-child(2)').innerHTML =
                i18next.t('household_quintile_definition');

            // Update examples
            document.getElementById('percentileExample').innerHTML =
                i18next.t('household_quintile_example', { q1_avg: q1_avg });

            document.getElementById('medianExample').innerHTML =
                i18next.t('household_quintile_middle', { q3_avg: q3_avg });
        }
        
        async function calculateIndividual() {
            const income = parseFloat(document.getElementById('income').value);
            const age = parseInt(document.getElementById('age').value);

            if (isNaN(income) || income < 0) {
                alert(i18next.t('error_invalid_income'));
                return;
            }

            if (isNaN(age) || age < 15 || age > 100) {
                alert(i18next.t('error_invalid_age'));
                return;
            }

            try {
                // Load manifest to ensure cache is up to date
                await dataCache.getManifest();

                // Fetch distribution data from local JSON
                const filename = getDataFilename(age);
                const distribution = await dataCache.getData(filename);

                if (!distribution) {
                    throw new Error(`No data found for age group: ${age}`);
                }

                // Calculate percentile using client-side function
                const percentile = calculatePercentile(income, distribution);
                const belowYou = Math.floor(percentile);
                const bracket = getIncomeBracket(percentile);

                // Calculate comparison to median
                const median = distribution.median;
                const diffFromMedian = income - median;
                const percentDiffFromMedian = ((diffFromMedian / median) * 100).toFixed(1);

                // Calculate comparison to average
                const average = distribution.average;
                const diffFromAverage = income - average;
                const percentDiffFromAverage = ((diffFromAverage / average) * 100).toFixed(1);

                // Create data object matching the API response format
                const data = {
                    income,
                    age,
                    ageGroup: getAgeGroupLabel(age),
                    geography: distribution.geography,
                    demographic: distribution.demographicLabel,
                    year: distribution.year,
                    percentile: percentile,
                    belowYou,
                    bracket,
                    median: {
                        value: median,
                        difference: Math.round(diffFromMedian),
                        percentDifference: parseFloat(percentDiffFromMedian)
                    },
                    average: {
                        value: average,
                        difference: Math.round(diffFromAverage),
                        percentDifference: parseFloat(percentDiffFromAverage)
                    }
                };

                // Generate message using data with translations
                let message = `<p><strong>${i18next.t('result_message_main', {
                    age: age,
                    percentile: data.percentile.toFixed(1),
                    ageGroup: data.ageGroup
                })}</strong></p>`;

                const diff = data.median.difference;
                const percentDiff = Math.abs(data.median.percentDifference);

                if (diff > 0) {
                    message += `<p>${i18next.t('result_message_more', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else if (diff < 0) {
                    message += `<p>${i18next.t('result_message_less', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else {
                    message += `<p>${i18next.t('result_message_exact', {
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                }

                message += `<p>${i18next.t('result_message_bracket', { bracket: data.bracket })}</p>`;

                document.getElementById('message').innerHTML = message;

                // Update URL with parameters for sharing
                const url = new URL(window.location.href);
                url.searchParams.set('income', income);
                url.searchParams.set('age', age);
                window.history.pushState({}, '', url);

                // Show results and message box
                document.getElementById('message').style.display = 'block';
                document.getElementById('results').classList.add('show');
                updateLegend(distribution.percentiles);
                updatePercentileExamples(distribution.percentiles);
                createChart(income, distribution.percentiles);

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error:', error);
                alert(i18next.t('error_api_connection'));
            }
        }

        // Helper function to format currency in thousands
        function formatCurrencyK(value) {
            if (value === 0) return '$0';
            const k = Math.round(value / 1000);
            return '$' + k + 'k';
        }

        // Generate distribution data for household income (quintile-based)
        function generateHouseholdDistributionData(quintiles) {
            // Extract averages - these are at the MIDDLE of each quintile (10th, 30th, 50th, 70th, 90th percentiles)
            const averages = [
                quintiles.q1.average,
                quintiles.q2.average,
                quintiles.q3.average,
                quintiles.q4.average,
                quintiles.q5.average
            ];

            // Calculate midpoints between averages to create quintile boundaries (20th, 40th, 60th, 80th percentiles)
            const boundaries = [];
            for (let i = 0; i < averages.length - 1; i++) {
                boundaries.push((averages[i] + averages[i + 1]) / 2);
            }

            // Create 5 brackets based on quintile boundaries
            // Q1: $0 to Q1/Q2 boundary (0-20th percentile, average at ~10th)
            // Q2: Q1/Q2 boundary to Q2/Q3 boundary (20-40th percentile, average at ~30th)
            // Q3: Q2/Q3 boundary to Q3/Q4 boundary (40-60th percentile, average at ~50th)
            // Q4: Q3/Q4 boundary to Q4/Q5 boundary (60-80th percentile, average at ~70th)
            // Q5: Q4/Q5 boundary and above (80-100th percentile, average at ~90th)
            const brackets = [
                {
                    label: '$0 - ' + formatCurrencyK(boundaries[0]),
                    min: 0,
                    max: boundaries[0],
                    average: averages[0],
                    percentage: 20,
                    percentileLabel: 'Q1 (0-20th)',
                    quintile: 1
                },
                {
                    label: formatCurrencyK(boundaries[0]) + ' - ' + formatCurrencyK(boundaries[1]),
                    min: boundaries[0],
                    max: boundaries[1],
                    average: averages[1],
                    percentage: 20,
                    percentileLabel: 'Q2 (20-40th)',
                    quintile: 2
                },
                {
                    label: formatCurrencyK(boundaries[1]) + ' - ' + formatCurrencyK(boundaries[2]),
                    min: boundaries[1],
                    max: boundaries[2],
                    average: averages[2],
                    percentage: 20,
                    percentileLabel: 'Q3 (40-60th)',
                    quintile: 3
                },
                {
                    label: formatCurrencyK(boundaries[2]) + ' - ' + formatCurrencyK(boundaries[3]),
                    min: boundaries[2],
                    max: boundaries[3],
                    average: averages[3],
                    percentage: 20,
                    percentileLabel: 'Q4 (60-80th)',
                    quintile: 4
                },
                {
                    label: formatCurrencyK(boundaries[3]) + '+',
                    min: boundaries[3],
                    max: averages[4] * 1.5, // Extend beyond Q5 average
                    average: averages[4],
                    percentage: 20,
                    percentileLabel: 'Q5 (80-100th)',
                    quintile: 5
                }
            ];

            return brackets;
        }

        async function calculateHousehold() {
            const income = parseFloat(document.getElementById('household-income').value);

            if (isNaN(income) || income < 0) {
                alert(i18next.t('error_invalid_income'));
                return;
            }

            try {
                // Load manifest to ensure cache is up to date
                await dataCache.getManifest();

                // Fetch household distribution data from local JSON
                const householdData = await dataCache.getData('household-income-canada');

                if (!householdData || !householdData.quintiles) {
                    throw new Error('Household income data not available');
                }

                // Calculate quintile and percentile using client-side functions
                const quintileInfo = calculateHouseholdQuintile(income, householdData.quintiles);
                const percentile = calculateHouseholdPercentile(income, householdData.quintiles);
                const belowYou = Math.floor(percentile);
                const bracket = getHouseholdBracket(quintileInfo.quintile);

                // Create data object matching the API response format
                const data = {
                    income,
                    geography: householdData.geography,
                    year: householdData.year,
                    quintile: quintileInfo.quintile,
                    quintileLabel: quintileInfo.label,
                    percentile: percentile,
                    belowYou,
                    bracket
                };

                // Generate message using data with translations
                let message = `<p><strong>${i18next.t('household_result_message_main', {
                    percentile: data.percentile.toPrecision(2)
                })}</strong></p>`;

                message += `<p>${i18next.t('household_result_message_bracket', { bracket: data.bracket })}</p>`;

                document.getElementById('message').innerHTML = message;

                // Update URL with parameters for sharing
                const url = new URL(window.location.href);
                url.searchParams.set('household-income', income);
                url.searchParams.delete('income');
                url.searchParams.delete('age');
                window.history.pushState({}, '', url);

                // Show results and message box
                document.getElementById('message').style.display = 'block';
                document.getElementById('results').classList.add('show');

                // Update legend with quintile data
                updateHouseholdLegend(householdData);

                // Update explanation box with quintile examples
                updateQuintileExamples(householdData.quintiles);

                // Create chart with quintile data
                createHouseholdChart(income, householdData.quintiles);

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error:', error);
                alert(i18next.t('error_api_connection'));
            }
        }

        function updateHouseholdLegend(householdData) {
            const legendGrid = document.getElementById('legendGrid');

            const quintileLabels = [
                { key: 'quintile_q1', average: householdData.quintiles.q1.average },
                { key: 'quintile_q2', average: householdData.quintiles.q2.average },
                { key: 'quintile_q3', average: householdData.quintiles.q3.average },
                { key: 'quintile_q4', average: householdData.quintiles.q4.average },
                { key: 'quintile_q5', average: householdData.quintiles.q5.average }
            ];

            legendGrid.innerHTML = quintileLabels.map(item => `
                <div class="legend-item">
                    <div class="legend-percentile">${i18next.t(item.key)}</div>
                    <div class="legend-income">Avg: $${item.average.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function createHouseholdChart(userIncome, quintiles) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const brackets = generateHouseholdDistributionData(quintiles);

            // Find which quintile the user falls into
            let userQuintileIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (userIncome >= brackets[i].min && userIncome <= brackets[i].max) {
                    userQuintileIndex = i;
                    break;
                }
            }
            if (userQuintileIndex === -1 && userIncome >= brackets[brackets.length - 1].max) {
                userQuintileIndex = brackets.length - 1;
            }

            // Create colors - same style as individual chart
            const backgroundColors = brackets.map((bracket, index) => {
                if (index < userQuintileIndex) {
                    return 'rgba(180, 180, 180, 0.6)'; // Dark grey for below user
                } else if (index === userQuintileIndex) {
                    return 'rgba(213, 43, 30, 0.8)'; // Red for user's quintile
                } else {
                    return 'rgba(220, 220, 220, 0.5)'; // Light grey for above user
                }
            });

            const borderColors = brackets.map((bracket, index) => {
                if (index < userQuintileIndex) {
                    return 'rgba(140, 140, 140, 1)';
                } else if (index === userQuintileIndex) {
                    return 'rgba(213, 43, 30, 1)';
                } else {
                    return 'rgba(180, 180, 180, 0.8)';
                }
            });

            const percentileAnnotations = {};

            // Add user income line
            const userXPosition = getXPositionForIncome(userIncome, brackets, quintiles);
            percentileAnnotations.userIncomeLine = {
                type: 'line',
                xMin: userXPosition,
                xMax: userXPosition,
                borderColor: 'rgba(213, 43, 30, 0.9)',
                borderWidth: 4,
                label: {
                    display: true,
                    content: `${i18next.t('chart_you_label')}: $${userIncome.toLocaleString()}`,
                    position: 'start',
                    backgroundColor: 'rgba(213, 43, 30, 0.9)',
                    color: 'white',
                    font: {
                        size: 11,
                        weight: 'bold'
                    },
                    padding: 6,
                    yAdjust: 10
                }
            };

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brackets.map(b => b.label),
                    datasets: [{
                        label: 'Percentage of Households',
                        data: brackets.map(b => b.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bracket = brackets[context.dataIndex];
                                    return [
                                        `${context.parsed.y}% of households`,
                                        `Range: ${bracket.percentileLabel}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: percentileAnnotations
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                const bracket = brackets[context.dataIndex];
                                return `Q${bracket.quintile}`;
                            },
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            title: {
                                display: true,
                                text: i18next.t('chart_y_axis')
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: i18next.t('chart_x_axis')
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Load values from URL parameters on page load
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const income = urlParams.get('income');
            const age = urlParams.get('age');
            const householdIncome = urlParams.get('household-income');

            // Determine which mode to use
            if (householdIncome || mode === 'household') {
                // Switch to household tab (preserve data during initial load)
                switchTab('household', true);
                if (householdIncome) {
                    document.getElementById('household-income').value = householdIncome;
                    // Automatically calculate
                    calculateHousehold();
                }
            } else if ((income && age) || mode === 'individual') {
                // Switch to individual tab (preserve data during initial load)
                switchTab('individual', true);
                if (income && age) {
                    document.getElementById('income').value = income;
                    document.getElementById('age').value = age;
                    // Automatically calculate
                    calculateIndividual();
                }
            } else {
                // Default to individual tab if no mode specified
                switchTab('individual', false);
            }
        }

        // Allow Enter key to submit from either input
        document.getElementById('income').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateIndividual();
            }
        });

        document.getElementById('age').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateIndividual();
            }
        });

        document.getElementById('household-income').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateHousehold();
            }
        });
    </script>

    <!-- GoatCounter Analytics - Privacy-friendly web analytics -->
    <!-- Only load in production (not on localhost or file://) -->
    <!-- SPA-compatible implementation: tracks initial load + hash navigation (TOC links) -->
    <script>
        // Check if we're NOT in a local development environment
        const isProduction = window.location.hostname !== 'localhost'
                          && window.location.hostname !== '127.0.0.1'
                          && window.location.protocol !== 'file:';

        if (isProduction) {
            // Configure GoatCounter for SPA
            // Disable automatic page load tracking - we'll track manually
            window.goatcounter = {
                no_onload: true
            };

            // Load GoatCounter script
            const script = document.createElement('script');
            script.setAttribute('data-goatcounter', 'https://matthieugd.goatcounter.com/count');
            script.async = true;
            script.src = '//gc.zgo.at/count.js';

            // Track initial page load after script loads
            script.onload = function() {
                if (window.goatcounter && window.goatcounter.count) {
                    window.goatcounter.count({
                        path: location.pathname + location.search + location.hash,
                    });
                }
            };

            document.body.appendChild(script);

            // Track hash changes (e.g., clicking TOC links like #faq1, #changelog)
            window.addEventListener('hashchange', function(e) {
                if (window.goatcounter && window.goatcounter.count) {
                    window.goatcounter.count({
                        path: location.pathname + location.search + location.hash,
                    });
                }
            });
        } else {
            console.log('GoatCounter analytics disabled in local development environment');
        }
    </script>
</body>
</html>
