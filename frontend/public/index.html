<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Comparison - Canada</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f3f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #d52b1e;
        }
        
        button {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            background: #d52b1e;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(213, 43, 30, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .legend-percentile {
            font-weight: 600;
            color: #d52b1e;
            font-size: 0.95em;
        }
        
        .legend-income {
            color: #666;
            font-size: 0.9em;
        }
        
        .comparison-message {
            background: #ffeaea;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .comparison-message p {
            color: #8b1a10;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .comparison-message p:last-child {
            margin-bottom: 0;
        }
        
        .explanation-box {
            background: #f8f9fa;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .explanation-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .explanation-box p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .explanation-box p:last-child {
            margin-bottom: 0;
        }
        
        .faq-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e0e0e0;
        }
        
        .faq-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .faq-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d52b1e;
        }
        
        .faq-question {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
            margin-bottom: 10px;
        }
        
        .faq-answer {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 0.85em;
            color: #666;
        }

        .footer p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .footer a {
            color: #d52b1e;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: #a32216;
            text-decoration: underline;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .lang-btn {
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            transform: none;
            box-shadow: none;
            background: #f0f0f0;
        }

        .lang-btn.active {
            background: #d52b1e;
            color: white;
        }

        /* Tab Navigation */
        .comparison-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab-btn {
            padding: 14px 28px;
            font-size: 1em;
            font-weight: 600;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn:hover {
            background: #e8e8e8;
            color: #333;
        }

        .tab-btn.active {
            background: #d52b1e;
            color: white;
            border-color: #d52b1e;
            z-index: 1;
        }

        .tab-btn.active:hover {
            background: #c02718;
        }

        .tab-content {
            display: none;
            border: 1px solid #e0e0e0;
            border-top: 2px solid #d52b1e;
            border-radius: 0 8px 8px 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .tab-content .input-section {
            padding: 24px;
            margin: 0;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        .info-note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1565c0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .language-switcher {
                top: 10px;
                right: 10px;
                padding: 4px;
            }

            .lang-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .comparison-tabs {
                gap: 5px;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 0.85em;
                margin-bottom: 20px;
            }
            
            .input-section {
                padding: 20px;
            }
            
            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .input-field {
                width: 100%;
            }
            
            .input-field label {
                font-size: 0.9em;
            }
            
            input {
                padding: 12px 15px;
                font-size: 1em;
                width: 100%;
            }
            
            button {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .comparison-message {
                padding: 15px;
                font-size: 0.95em;
            }
            
            .comparison-message p {
                font-size: 0.95em;
            }
            
            .chart-container {
                height: 300px;
                padding: 15px;
            }
            
            .legend {
                padding: 15px;
            }
            
            .legend-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .legend-percentile {
                font-size: 0.85em;
            }
            
            .legend-income {
                font-size: 0.8em;
            }
            
            .explanation-box {
                padding: 15px;
            }
            
            .explanation-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .explanation-box p {
                font-size: 0.85em;
            }
            
            .faq-section {
                margin-top: 30px;
                padding-top: 30px;
            }
            
            .faq-title {
                font-size: 1.4em;
                margin-bottom: 20px;
            }
            
            .faq-item {
                padding: 15px;
            }
            
            .faq-question {
                font-size: 0.95em;
            }
            
            .faq-answer {
                font-size: 0.85em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .input-section {
                padding: 25px;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="language-switcher">
        <button class="lang-btn active" data-lang="en">English</button>
        <button class="lang-btn" data-lang="fr">Fran√ßais</button>
    </div>

    <div class="container">
        <h1 data-i18n="title">üá®üá¶ Compare Your Salary In Canada </h1>
        <p class="subtitle" data-i18n="subtitle">Compare your income against Canadian income distribution.</p>

        <!-- Comparison Mode Tabs -->
        <div class="comparison-tabs">
            <button class="tab-btn active" data-tab="individual" data-i18n="tab_individual">üíº Individual Salary (2020)</button>
            <button class="tab-btn" data-tab="household" data-i18n="tab_household">üè† Household Income (2024)</button>
        </div>

        <!-- Individual Salary Tab Content -->
        <div class="tab-content active" id="individual-tab">
            <div class="input-section">
                <div class="input-group">
                    <div class="input-wrapper">
                        <div class="input-field">
                            <label for="income" data-i18n="income_label">Your annual wage ($)</label>
                            <input
                                type="number"
                                id="income"
                                data-i18n="[placeholder]income_placeholder"
                                placeholder="65000"
                                min="0"
                                step="1000"
                            >
                        </div>
                        <div class="input-field">
                            <label for="age" data-i18n="age_label">Your age</label>
                            <input
                                type="number"
                                id="age"
                                data-i18n="[placeholder]age_placeholder"
                                placeholder="30"
                                min="15"
                                max="100"
                                step="1"
                            >
                        </div>
                        <button onclick="calculateIndividual()" data-i18n="compare_button">Compare</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Household Income Tab Content -->
        <div class="tab-content" id="household-tab">
            <div class="input-section">
                <div class="input-group">
                    <div class="input-wrapper">
                        <div class="input-field">
                            <label for="household-income" data-i18n="household_income_label">Household annual income ($)</label>
                            <input
                                type="number"
                                id="household-income"
                                data-i18n="[placeholder]household_income_placeholder"
                                placeholder="95000"
                                min="0"
                                step="1000"
                            >
                        </div>
                        <button onclick="calculateHousehold()" data-i18n="compare_button">Compare</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison-message" id="message" style="display: none;"></div>
        
        <div class="results" id="results">
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
            
            <div class="legend">
                <div class="legend-title" data-i18n="legend_title">üìä Income Distribution Percentiles</div>
                <div class="legend-grid" id="legendGrid"></div>
            </div>

            <div class="explanation-box">
                <div class="explanation-title" data-i18n="explanation_title">üí° Understanding Percentiles</div>
                <p data-i18n="[html]percentile_definition"><strong>What is a percentile?</strong> A percentile tells you what percentage of people earn less than a given amount.</p>
                <p id="percentileExample" data-i18n-base="percentile_example"><strong>Example:</strong> The <strong>25th percentile (P25)</strong> tells you the income level where 25% of people earn less and 75% earn more.</p>
                <p id="medianExample" data-i18n-base="median_example"><strong>The median (P50)</strong> is the middle point where exactly 50% of people earn less and 50% earn more. It's the most common way to describe "typical" income.</p>
            </div>
        </div>
        
        <div class="faq-section">
            <h2 class="faq-title" data-i18n="faq_title">‚ùì Frequently Asked Questions</h2>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq1_question">What's the purpose of this website?</div>
                <div class="faq-answer" data-i18n="[html]faq1_answer">
                    We often hear about the "average salary" in Canada, but averages can be misleading due to high earners skewing the data. This website aims to provide a clearer picture of income distribution using percentiles, allowing individuals to see how their earnings compare to others in Canada based on reliable census data and annual surveys.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq6_question">What's the difference between Individual Salary and Household Income comparisons?</div>
                <div class="faq-answer" data-i18n="[html]faq6_answer">
                    <strong>Individual Salary</strong> compares your personal employment income (wages and salaries) to other individuals in your age group using detailed census percentile data (P10, P25, P50, P75, P90, P95, P99). This is best for understanding where your personal earnings stand. <strong>Household Income</strong> compares the combined income of all people in your household to other Canadian households using quintile data (5 groups of 20% each). This gives a broader picture of your household's economic situation, regardless of how many earners contribute. Note that household data is not age-specific and uses broader income ranges.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq2_question">Where does this data come from?</div>
                <div class="faq-answer" data-i18n="[html]faq2_answer">
                    The individual salary data comes from <strong><a href="https://www12.statcan.gc.ca/census-recensement/index-eng.cfm" title="Census website">Statistics Canada's Census of Population 2021</a></strong>, which is the most comprehensive and reliable source for income distribution in Canada. The census surveys millions of Canadians and provides official government statistics on employment income. The household income data comes from Statistics Canada's annual <strong><a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610058701" title="Household income survey">Household Income Survey (table 36-10-0587-01)</a></strong>.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq3_question">How current is this data?</div>
                <div class="faq-answer" data-i18n="[html]faq3_answer">
                    The individual salary data reflects the <strong>2020 calendar year</strong> (collected during the 2021 Census). While this is the most recent comprehensive census data available, please note that income levels and distributions may have changed since 2020 due to inflation, economic growth, and other factors. The website will be updated when the next census data becomes available in 2026-2027. The household income data reflects the <strong>2024 calendar year</strong> (collected during the 2025 survey). This is the most recent annual household income data available from Statistics Canada.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq4_question">What does "wage" include?</div>
                <div class="faq-answer" data-i18n="[html]faq4_answer">
                    Gross wages and salaries before deductions for such items as income taxes, pension plan contributions, and employment insurance premiums during the reference period. <a href="https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-eng.cfm?ID=pop128" title="Statistics Canada definition">Source</a>
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" data-i18n="faq5_question">What does "household income" include?</div>
                <div class="faq-answer" data-i18n="[html]faq5_answer">
                    It's based on the Household Income Survey (table 36-10-0587-01), which doesn't have the same level of detail as the census income data. To get an approximation of the income as we commonly think of it (i.e., the amount we see in our employment contract before taxes), we added back the "current transfers paid" to the disposable income.
                </div>
            </div>


        </div>

        <div class="footer">
            <p data-i18n="[html]footer_author">Created by <a href="https://matthieugd.com" target="_blank" rel="noopener noreferrer">Matthieu Guyonnet-Duluc</a>.</p>
            <p data-i18n="[html]footer_thanks">Special thanks to <a href="https://x.com/PhilSmith26" target="_blank" rel="noopener noreferrer">Philip Smith</a> for his invaluable help. Any errors are my own.</p>
            <p data-i18n="[html]footer_contact">Questions or feedback? <a href="https://matthieugd.com/a-propos/" target="_blank" rel="noopener noreferrer">Contact me</a>.</p>
        </div>
    </div>

    <script>
        // i18next initialization
        const translations = {
            en: {
                translation: {
                    title: "üá®üá¶ Compare Your Salary In Canada",
                    subtitle: "Compare your income against Canadian income distribution.",
                    income_label: "Your annual wage ($)",
                    income_placeholder: "65000",
                    age_label: "Your age",
                    age_placeholder: "30",
                    compare_button: "Compare",
                    legend_title: "üìä Income Distribution Percentiles",
                    explanation_title: "üí° Understanding Percentiles",
                    percentile_definition: "<strong>What is a percentile?</strong> A percentile tells you what percentage of people earn less than a given amount.",
                    percentile_example: "<strong>Example:</strong> The <strong>25th percentile (P25) is ${{p25}}</strong>. This means 25% of Canadians in this age group earn less than ${{p25}}, and 75% earn more.",
                    median_example: "<strong>The median (P50) is ${{p50}}</strong>. This is the middle point where exactly 50% of people earn less and 50% earn more. It's the most common way to describe \"typical\" income.",
                    faq_title: "‚ùì Frequently Asked Questions",
                    faq1_question: "What's the purpose of this website?",
                    faq1_answer: "We often hear about the \"average salary\" in Canada, but averages can be misleading due to high earners skewing the data. This website aims to provide a clearer picture of income distribution using percentiles, allowing individuals to see how their earnings compare to others in Canada based on reliable census data and annual surveys.",
                    faq2_question: "Where does this data come from?",
                    faq2_answer: "The individual salary data comes from <strong><a href=\"https://www12.statcan.gc.ca/census-recensement/index-eng.cfm\" title=\"Census website\">Statistics Canada's Census of Population 2021</a></strong>, which is the most comprehensive and reliable source for income distribution in Canada. The census surveys millions of Canadians and provides official government statistics on employment income. The household income data comes from Statistics Canada's annual <strong><a href=\"https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610058701\" title=\"Household income survey\">Household Income Survey (table 36-10-0587-01)</a></strong>.",
                    faq3_question: "How current is this data?",
                    faq3_answer: "The individual salary data reflects the <strong>2020 calendar year</strong> (collected during the 2021 Census). While this is the most recent comprehensive census data available, please note that income levels and distributions may have changed since 2020 due to inflation, economic growth, and other factors. The website will be updated when the next census data becomes available in 2026-2027. The household income data reflects the <strong>2024 calendar year</strong> (collected during the 2025 survey). This is the most recent annual household income data available from Statistics Canada.",
                    faq4_question: "What does \"wage\" include?",
                    faq4_answer: "Gross wages and salaries before deductions for such items as income taxes, pension plan contributions, and employment insurance premiums during the reference period. <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-eng.cfm?ID=pop128\" title=\"Statistics Canada definition\">Source</a>",
                    faq5_question: "What does \"household income\" include?",
                    faq5_answer: "It's based on the Household Income Survey (table 36-10-0587-01), which doesn't have the same level of detail as the census income data. To get an approximation of the income as we commonly think of it (i.e., the amount we see in our employment contract before taxes), we added back the \"current transfers paid\" to the disposable income.",
                    percentile_p10: "10th Percentile (P10)",
                    percentile_p25: "25th Percentile (P25)",
                    percentile_p50: "50th Percentile (Median)",
                    percentile_p75: "75th Percentile (P75)",
                    percentile_p90: "90th Percentile (P90)",
                    percentile_p95: "95th Percentile (P95)",
                    percentile_p99: "99th Percentile (P99)",
                    chart_you_label: "YOU",
                    chart_x_axis: "Income Ranges",
                    chart_y_axis: "Percentage of Population (%)",
                    chart_tooltip_canadians: "of Canadians",
                    chart_tooltip_percentile: "Percentile range",
                    result_message_main: "At age {{age}}, you earn more than {{percentile}}% of Canadians with employment income in your age group ({{ageGroup}}).",
                    result_message_more: "You earn ${{diff}} ({{percentDiff}}%) <strong>more</strong> than the median income for your age group (${{median}}).",
                    result_message_less: "You earn ${{diff}} ({{percentDiff}}%) <strong>less</strong> than the median income for your age group (${{median}}).",
                    result_message_exact: "You earn exactly the median income for your age group (${{median}}).",
                    result_message_bracket: "Income bracket: <strong>{{bracket}}</strong>",
                    error_invalid_income: "Please enter a valid income amount",
                    error_invalid_age: "Please enter a valid age (15-100)",
                    error_api_connection: "Error connecting to the backend API. Please make sure the server is running.",
                    tab_individual: "üíº Individual Salary (2020)",
                    tab_household: "üè† Household Income (2024)",
                    household_income_label: "Household annual income ($)",
                    household_income_placeholder: "95000",
                    household_note: "üí° <strong>Household income</strong> is the combined annual income of all household members before taxes. This includes wages, salaries, and self-employment income for everyone living in your home.",
                    household_result_message_main: "Your household earns more than {{percentile}}% of Canadian households.",
                    household_result_message_more: "Your household earns ${{diff}} ({{percentDiff}}%) <strong>more</strong> than the median household income (${{median}}).",
                    household_result_message_less: "Your household earns ${{diff}} ({{percentDiff}}%) <strong>less</strong> than the median household income (${{median}}).",
                    household_result_message_exact: "Your household earns exactly the median household income (${{median}}).",
                    household_result_message_bracket: "Income bracket: <strong>{{bracket}}</strong>",
                    quintile_q1: "First Quintile (Q1) - Bottom 20%",
                    quintile_q2: "Second Quintile (Q2)",
                    quintile_q3: "Third Quintile (Q3) - Middle 20%",
                    quintile_q4: "Fourth Quintile (Q4)",
                    quintile_q5: "Fifth Quintile (Q5) - Top 20%",
                    faq6_question: "What's the difference between Individual Salary and Household Income comparisons?",
                    faq6_answer: "<strong>Individual Salary</strong> compares your personal employment income (wages and salaries) to other individuals in your age group using detailed census percentile data (P10, P25, P50, P75, P90, P95, P99). This is best for understanding where your personal earnings stand.<br><br><strong>Household Income</strong> compares the combined income of all people in your household to other Canadian households using quintile data (5 groups of 20% each). This gives a broader picture of your household's economic situation, regardless of how many earners contribute. Note that household data is not age-specific and uses broader income ranges.",
                    footer_author: "Created by <a href=\"https://matthieugd.com\" target=\"_blank\" rel=\"noopener noreferrer\">Matthieu Guyonnet-Duluc</a>.",
                    footer_thanks: "Special thanks to <a href=\"https://x.com/PhilSmith26\" target=\"_blank\" rel=\"noopener noreferrer\">Philip Smith</a> for his invaluable help. Any errors are my own.",
                    footer_contact: "Questions or feedback? <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">Contact me</a>."
                }
            },
            fr: {
                translation: {
                    title: "üá®üá¶ Comparez Votre Salaire au Canada",
                    subtitle: "Comparez votre salaire avec la distribution des revenus canadiens.",
                    income_label: "Votre salaire annuel ($)",
                    income_placeholder: "65000",
                    age_label: "Votre √¢ge",
                    age_placeholder: "30",
                    compare_button: "Comparer",
                    legend_title: "üìä Percentiles de Distribution des Revenus",
                    explanation_title: "üí° Comprendre les Percentiles",
                    percentile_definition: "<strong>Qu'est-ce qu'un percentile?</strong> Un percentile indique le pourcentage de personnes gagnant moins qu'un montant donn√©.",
                    percentile_example: "<strong>Exemple:</strong> Le <strong>25e percentile (P25) est de {{p25}} $</strong>. Cela signifie que 25 % des Canadiens de ce groupe d'√¢ge gagnent moins de {{p25}} $ et 75 % gagnent plus.",
                    median_example: "<strong>La m√©diane (P50) est de {{p50}} $</strong>. C'est le point m√©dian o√π exactement 50 % des personnes gagnent moins et 50 % gagnent plus. C'est la fa√ßon la plus courante de d√©crire le revenu \"typique\".",
                    faq_title: "‚ùì Questions Fr√©quemment Pos√©es",
                    faq1_question: "Quel est le but de ce site web?",
                    faq1_answer: "On entend souvent parler du \"salaire moyen\" au Canada, mais les moyennes peuvent √™tre trompeuses en raison des hauts salaires qui faussent les donn√©es. Ce site vise √† fournir une image plus claire de la distribution des revenus en utilisant les percentiles, permettant aux individus de voir comment leurs gains se comparent aux autres au Canada selon des donn√©es de recensement fiables et des enqu√™tes annuelles.",
                    faq2_question: "D'o√π proviennent ces donn√©es?",
                    faq2_answer: "Les donn√©es de salaire individuel proviennent du <strong><a href=\"https://www12.statcan.gc.ca/census-recensement/index-fra.cfm\" title=\"Site du recensement\">Recensement de la population 2021 de Statistique Canada</a></strong>, qui est la source la plus compl√®te et fiable pour la distribution des revenus au Canada. Le recensement interroge des millions de Canadiens et fournit des statistiques gouvernementales officielles sur les revenus d'emploi. Les donn√©es de revenu des m√©nages proviennent de l'<strong><a href=\"https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=3610058701\" title=\"Enqu√™te sur le revenu des m√©nages\">Enqu√™te annuelle sur le revenu des m√©nages de Statistique Canada (tableau 36-10-0587-01)</a></strong>.",
                    faq3_question: "√Ä quel point ces donn√©es sont-elles r√©centes?",
                    faq3_answer: "Les donn√©es de salaire individuel refl√®tent l'<strong>ann√©e civile 2020</strong> (collect√©es lors du recensement de 2021). Bien qu'il s'agisse des donn√©es de recensement compl√®tes les plus r√©centes disponibles, veuillez noter que les niveaux de revenus et les distributions peuvent avoir chang√© depuis 2020 en raison de l'inflation, de la croissance √©conomique et d'autres facteurs. Le site sera mis √† jour lorsque les prochaines donn√©es de recensement seront disponibles en 2026-2027. Les donn√©es de revenu des m√©nages refl√®tent l'<strong>ann√©e civile 2024</strong> (collect√©es lors de l'enqu√™te de 2025). Il s'agit des donn√©es annuelles les plus r√©centes disponibles de Statistique Canada sur le revenu des m√©nages.",
                    faq4_question: "Que comprend le \"salaire\"?",
                    faq4_answer: "Les salaires et traitements bruts avant les retenues pour les imp√¥ts sur le revenu, les cotisations √† un r√©gime de pension et au programme d'assurance-emploi au cours de la p√©riode de r√©f√©rence. <a href=\"https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-fra.cfm?ID=pop128\" title=\"D√©finition de Statistique Canada\">Source</a>",
                    faq5_question: "Que comprend le \"revenu des m√©nages\"?",
                    faq5_answer: "Il est bas√© sur l'Enqu√™te sur le revenu des m√©nages (tableau 36-10-0587-01), qui ne pr√©sente pas le m√™me niveau de d√©tail que les donn√©es de revenu du recensement. Pour obtenir une approximation du revenu tel que nous le concevons couramment (c'est-√†-dire le montant que nous voyons dans notre contrat de travail avant les imp√¥ts), nous avons ajout√© les \"transferts courants vers√©s\" au revenu disponible.",
                    percentile_p10: "10e Percentile (P10)",
                    percentile_p25: "25e Percentile (P25)",
                    percentile_p50: "50e Percentile (M√©diane)",
                    percentile_p75: "75e Percentile (P75)",
                    percentile_p90: "90e Percentile (P90)",
                    percentile_p95: "95e Percentile (P95)",
                    percentile_p99: "99e Percentile (P99)",
                    chart_you_label: "VOUS",
                    chart_x_axis: "Tranches de Revenu",
                    chart_y_axis: "Pourcentages de la Population (%)",
                    chart_tooltip_canadians: "des Canadiens",
                    chart_tooltip_percentile: "Plage de percentile",
                    result_message_main: "√Ä {{age}} ans, vous gagnez plus que {{percentile}} % des Canadiens ayant un revenu d'emploi dans votre groupe d'√¢ge ({{ageGroup}}).",
                    result_message_more: "Vous gagnez {{diff}} $ ({{percentDiff}} %) de <strong>plus</strong> que le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_less: "Vous gagnez {{diff}} $ ({{percentDiff}} %) de <strong>moins</strong> que le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_exact: "Vous gagnez exactement le revenu m√©dian pour votre groupe d'√¢ge ({{median}} $).",
                    result_message_bracket: "Tranche de revenu : <strong>{{bracket}}</strong>",
                    error_invalid_income: "Veuillez entrer un montant de revenu valide",
                    error_invalid_age: "Veuillez entrer un √¢ge valide (15-100)",
                    error_api_connection: "Erreur de connexion √† l'API backend. Veuillez vous assurer que le serveur fonctionne.",
                    tab_individual: "üíº Salaire Individuel (2020)",
                    tab_household: "üè† Revenu du M√©nage (2024)",
                    household_income_label: "Revenu annuel du m√©nage ($)",
                    household_income_placeholder: "95000",
                    household_note: "üí° Le <strong>revenu du m√©nage</strong> est le revenu annuel combin√© de tous les membres du m√©nage avant imp√¥ts. Cela comprend les salaires, traitements et revenus d'un travail autonome de toutes les personnes vivant dans votre foyer.",
                    household_result_message_main: "Votre m√©nage gagne plus que {{percentile}} % des m√©nages canadiens.",
                    household_result_message_more: "Votre m√©nage gagne {{diff}} $ ({{percentDiff}} %) de <strong>plus</strong> que le revenu m√©dian des m√©nages ({{median}} $).",
                    household_result_message_less: "Votre m√©nage gagne {{diff}} $ ({{percentDiff}} %) de <strong>moins</strong> que le revenu m√©dian des m√©nages ({{median}} $).",
                    household_result_message_exact: "Votre m√©nage gagne exactement le revenu m√©dian des m√©nages ({{median}} $).",
                    household_result_message_bracket: "Tranche de revenu : <strong>{{bracket}}</strong>",
                    quintile_q1: "Premier Quintile (Q1) - 20 % Inf√©rieur",
                    quintile_q2: "Deuxi√®me Quintile (Q2)",
                    quintile_q3: "Troisi√®me Quintile (Q3) - 20 % Moyen",
                    quintile_q4: "Quatri√®me Quintile (Q4)",
                    quintile_q5: "Cinqui√®me Quintile (Q5) - 20 % Sup√©rieur",
                    faq6_question: "Quelle est la diff√©rence entre les comparaisons de Salaire Individuel et de Revenu du M√©nage?",
                    faq6_answer: "<strong>Salaire Individuel</strong> compare votre revenu d'emploi personnel (salaires et traitements) √† d'autres individus de votre groupe d'√¢ge en utilisant des donn√©es de percentiles d√©taill√©es du recensement (P10, P25, P50, P75, P90, P95, P99). C'est id√©al pour comprendre o√π se situent vos gains personnels. <strong>Revenu du M√©nage</strong> compare le revenu combin√© de toutes les personnes de votre m√©nage √† d'autres m√©nages canadiens en utilisant des donn√©es de quintiles (5 groupes de 20 % chacun). Cela donne une image plus large de la situation √©conomique de votre m√©nage, peu importe le nombre de personnes qui contribuent. Notez que les donn√©es des m√©nages ne sont pas sp√©cifiques √† l'√¢ge et utilisent des fourchettes de revenus plus larges.",
                    footer_author: "Cr√©√© par <a href=\"https://matthieugd.com\" target=\"_blank\" rel=\"noopener noreferrer\">Matthieu Guyonnet-Duluc</a>.",
                    footer_thanks: "Remerciements sp√©ciaux √† <a href=\"https://x.com/PhilSmith26\" target=\"_blank\" rel=\"noopener noreferrer\">Philip Smith</a> pour son aide pr√©cieuse. Toutes les erreurs sont les miennes.",
                    footer_contact: "Questions ou commentaires? <a href=\"https://matthieugd.com/a-propos/\" target=\"_blank\" rel=\"noopener noreferrer\">Contactez-moi</a>."
                }
            }
        };

        // Initialize i18next
        i18next.init({
            lng: 'en',
            fallbackLng: 'en',
            resources: translations,
            interpolation: {
                escapeValue: false
            }
        });

        let chart = null;
        let currentLanguage = 'en';

        // Translation helper function
        function updatePageTranslations() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');

                // Handle different attribute types
                if (key.startsWith('[html]')) {
                    const actualKey = key.replace('[html]', '');
                    element.innerHTML = i18next.t(actualKey);
                } else if (key.startsWith('[placeholder]')) {
                    const actualKey = key.replace('[placeholder]', '');
                    element.placeholder = i18next.t(actualKey);
                } else {
                    element.textContent = i18next.t(key);
                }
            });

            // Update document title and HTML lang attribute
            document.documentElement.lang = currentLanguage;
            document.title = currentLanguage === 'fr'
                ? 'Comparaison de Revenu - Canada'
                : 'Income Comparison - Canada';
        }

        // Language switcher function
        function switchLanguage(lang) {
            currentLanguage = lang;
            i18next.changeLanguage(lang).then(() => {
                updatePageTranslations();

                // Update active button state
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
                });

                // Update URL parameter
                const url = new URL(window.location.href);
                url.searchParams.set('lang', lang);
                window.history.pushState({}, '', url);

                // Re-render chart and results if they're visible
                if (document.getElementById('results').classList.contains('show')) {
                    if (currentMode === 'individual') {
                        const income = parseFloat(document.getElementById('income').value);
                        const age = parseInt(document.getElementById('age').value);
                        if (!isNaN(income) && !isNaN(age)) {
                            calculateIndividual();
                        }
                    } else if (currentMode === 'household') {
                        const income = parseFloat(document.getElementById('household-income').value);
                        if (!isNaN(income)) {
                            calculateHousehold();
                        }
                    }
                }
            });
        }

        // Tab switching functionality
        let currentMode = 'individual'; // 'individual' or 'household'

        function switchTab(mode) {
            currentMode = mode;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === mode);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${mode}-tab`).classList.add('active');

            // Update URL parameter
            const url = new URL(window.location.href);
            url.searchParams.set('mode', mode);
            window.history.pushState({}, '', url);

            // Hide results when switching tabs
            document.getElementById('results').classList.remove('show');
            document.getElementById('message').style.display = 'none';
        }

        // Initialize language switcher buttons and tab switching
        document.addEventListener('DOMContentLoaded', function() {
            // Language switcher
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchLanguage(this.getAttribute('data-lang'));
                });
            });

            // Tab switcher
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });

            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Check for mode parameter
            const modeParam = urlParams.get('mode');
            if (modeParam && (modeParam === 'individual' || modeParam === 'household')) {
                switchTab(modeParam);
            }

            // Check for language parameter
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'en' || langParam === 'fr')) {
                switchLanguage(langParam);
            } else {
                // Detect browser language
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('fr')) {
                    switchLanguage('fr');
                } else {
                    updatePageTranslations();
                }
            }
        });

        function generateDistributionData(percentiles) {
            // Create income brackets with the number of people in each bracket
            // Based on percentile data, we can calculate approximate distributions
            const p10 = percentiles.p10;
            const p25 = percentiles.p25;
            const p50 = percentiles.p50;
            const p75 = percentiles.p75;
            const p90 = percentiles.p90;
            const p95 = percentiles.p95;
            const p99 = percentiles.p99;

            const brackets = [
                { min: 0, max: p10, midpoint: p10/2, percentage: 10, label: `$0-$${Math.round(p10/1000)}K`, percentileLabel: '10%' },
                { min: p10, max: p25, midpoint: (p10+p25)/2, percentage: 15, label: `$${Math.round(p10/1000)}K-$${Math.round(p25/1000)}K`, percentileLabel: '25%' },
                { min: p25, max: p50, midpoint: (p25+p50)/2, percentage: 25, label: `$${Math.round(p25/1000)}K-$${Math.round(p50/1000)}K`, percentileLabel: '50%' },
                { min: p50, max: p75, midpoint: (p50+p75)/2, percentage: 25, label: `$${Math.round(p50/1000)}K-$${Math.round(p75/1000)}K`, percentileLabel: '75%' },
                { min: p75, max: p90, midpoint: (p75+p90)/2, percentage: 15, label: `$${Math.round(p75/1000)}K-$${Math.round(p90/1000)}K`, percentileLabel: '90%' },
                { min: p90, max: p95, midpoint: (p90+p95)/2, percentage: 5, label: `$${Math.round(p90/1000)}K-$${Math.round(p95/1000)}K`, percentileLabel: '95%' },
                { min: p95, max: p99, midpoint: (p95+p99)/2, percentage: 4, label: `$${Math.round(p95/1000)}K-$${Math.round(p99/1000)}K`, percentileLabel: '99%' },
                { min: p99, max: p99 * 1.5, midpoint: p99 * 1.25, percentage: 1, label: `$${Math.round(p99/1000)}K+`, percentileLabel: '100%' }
            ];

            return brackets;
        }
        
        function createChart(userIncome, percentiles) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const brackets = generateDistributionData(percentiles);

            // Find which bracket the user falls into
            let userBracketIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (userIncome >= brackets[i].min && userIncome < brackets[i].max) {
                    userBracketIndex = i;
                    break;
                }
            }
            if (userBracketIndex === -1 && userIncome >= brackets[brackets.length - 1].max) {
                userBracketIndex = brackets.length - 1;
            }
            
            // Create colors - highlight brackets below user's income
            const backgroundColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(180, 180, 180, 0.6)'; // Grey for below user
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 0.8)'; // Red for user's bracket
                } else {
                    return 'rgba(220, 220, 220, 0.5)'; // Light grey for above user
                }
            });

            const borderColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(140, 140, 140, 1)';
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 1)';
                } else {
                    return 'rgba(180, 180, 180, 0.8)';
                }
            });
            
            // Create percentile markers
            const percentileAnnotations = {};
            
            // For bar charts, x positions are categorical (0, 1, 2, 3, etc. for each bar)
            // We need to calculate which bar and position within that bar
            function getXPositionForIncome(income) {
                // Find which bracket the income falls into
                let bracketIndex = -1;
                for (let i = 0; i < brackets.length; i++) {
                    if (income >= brackets[i].min && income <= brackets[i].max) {
                        bracketIndex = i;
                        break;
                    }
                }
                if (bracketIndex === -1 && income >= brackets[brackets.length - 1].max) {
                    bracketIndex = brackets.length - 1;
                }
                
                if (bracketIndex === -1) return 0;
                
                // Calculate position within the bracket (0 to 1)
                const bracket = brackets[bracketIndex];
                const range = bracket.max - bracket.min;
                const positionInBracket = range > 0 ? (income - bracket.min) / range : 0.5;
                
                // For bar charts, bars are centered at integer positions (0, 1, 2, etc.)
                // Each bar has width of ~0.8, so we offset by -0.4 to +0.4 from center
                const barWidth = 0.8;
                const offset = (positionInBracket - 0.5) * barWidth;
                
                return bracketIndex + offset;
            }
            
            // Add user income line
            const userXPosition = getXPositionForIncome(userIncome);
            percentileAnnotations.userIncomeLine = {
                type: 'line',
                xMin: userXPosition,
                xMax: userXPosition,
                borderColor: 'rgba(213, 43, 30, 0.9)',
                borderWidth: 4,
                label: {
                    display: true,
                    content: `${i18next.t('chart_you_label')}: $${userIncome.toLocaleString()}`,
                    position: 'start',
                    backgroundColor: 'rgba(213, 43, 30, 0.9)',
                    color: 'white',
                    font: {
                        size: 11,
                        weight: 'bold'
                    },
                    padding: 6,
                    yAdjust: 10
                }
            };
            
            const percentileLabels = [
                { key: 'p10', label: 'P10', value: percentiles.p10 },
                { key: 'p25', label: 'P25', value: percentiles.p25 },
                { key: 'p50', label: 'Median', value: percentiles.p50 },
                { key: 'p75', label: 'P75', value: percentiles.p75 },
                { key: 'p90', label: 'P90', value: percentiles.p90 },
                { key: 'p95', label: 'P95', value: percentiles.p95 },
                { key: 'p99', label: 'P99', value: percentiles.p99 }
            ];
            
            // No longer adding percentile border lines - they're now shown as labels on bars
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brackets.map(b => b.label),
                    datasets: [{
                        label: 'Percentage of Population',
                        data: brackets.map(b => b.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bracket = brackets[context.dataIndex];
                                    return [
                                        `${context.parsed.y}% ${i18next.t('chart_tooltip_canadians')}`,
                                        `${i18next.t('chart_tooltip_percentile')}: ${bracket.percentileLabel}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: percentileAnnotations
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                return brackets[context.dataIndex].percentileLabel;
                            },
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            padding: 4
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: i18next.t('chart_x_axis'),
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: i18next.t('chart_y_axis'),
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            max: 30,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function updateLegend(percentiles) {
            const legendGrid = document.getElementById('legendGrid');
            const percentileLabels = [
                { key: 'percentile_p10', value: percentiles.p10 },
                { key: 'percentile_p25', value: percentiles.p25 },
                { key: 'percentile_p50', value: percentiles.p50 },
                { key: 'percentile_p75', value: percentiles.p75 },
                { key: 'percentile_p90', value: percentiles.p90 },
                { key: 'percentile_p95', value: percentiles.p95 },
                { key: 'percentile_p99', value: percentiles.p99 }
            ];

            legendGrid.innerHTML = percentileLabels.map(item => `
                <div class="legend-item">
                    <div class="legend-percentile">${i18next.t(item.key)}</div>
                    <div class="legend-income">$${item.value.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function updatePercentileExamples(percentiles) {
            const p25 = percentiles.p25.toLocaleString();
            const p50 = percentiles.p50.toLocaleString();

            document.getElementById('percentileExample').innerHTML =
                i18next.t('percentile_example', { p25: p25 });

            document.getElementById('medianExample').innerHTML =
                i18next.t('median_example', { p50: p50 });
        }
        
        async function calculateIndividual() {
            const income = parseFloat(document.getElementById('income').value);
            const age = parseInt(document.getElementById('age').value);

            if (isNaN(income) || income < 0) {
                alert(i18next.t('error_invalid_income'));
                return;
            }

            if (isNaN(age) || age < 15 || age > 100) {
                alert(i18next.t('error_invalid_age'));
                return;
            }

            try {
                // Call the backend API
                const response = await fetch(`http://localhost:3001/api/income/percentile?income=${income}&age=${age}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch data from API');
                }

                const data = await response.json();

                // Generate message using API data with translations
                let message = `<p><strong>${i18next.t('result_message_main', {
                    age: age,
                    percentile: data.percentile.toFixed(1),
                    ageGroup: data.ageGroup
                })}</strong></p>`;

                const diff = data.median.difference;
                const percentDiff = Math.abs(data.median.percentDifference);

                if (diff > 0) {
                    message += `<p>${i18next.t('result_message_more', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else if (diff < 0) {
                    message += `<p>${i18next.t('result_message_less', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else {
                    message += `<p>${i18next.t('result_message_exact', {
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                }

                message += `<p>${i18next.t('result_message_bracket', { bracket: data.bracket })}</p>`;

                document.getElementById('message').innerHTML = message;

                // Update URL with parameters for sharing
                const url = new URL(window.location.href);
                url.searchParams.set('income', income);
                url.searchParams.set('age', age);
                window.history.pushState({}, '', url);

                // Fetch distribution data for the chart
                const distResponse = await fetch(`http://localhost:3001/api/income/distribution?age=${age}`);
                const distData = await distResponse.json();

                // Show results and message box
                document.getElementById('message').style.display = 'block';
                document.getElementById('results').classList.add('show');
                updateLegend(distData.percentiles);
                updatePercentileExamples(distData.percentiles);
                createChart(income, distData.percentiles);

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error:', error);
                alert(i18next.t('error_api_connection'));
            }
        }

        // Generate distribution data for household income (quintile-based)
        function generateHouseholdDistributionData(quintiles) {
            // Create 5 brackets based on quintiles
            const brackets = [
                {
                    label: '$0 - $35k',
                    min: quintiles.q1.min,
                    max: quintiles.q1.max,
                    percentage: 20,
                    percentileLabel: 'Q1 (0-20th)',
                    quintile: 1
                },
                {
                    label: '$35k - $62k',
                    min: quintiles.q2.min,
                    max: quintiles.q2.max,
                    percentage: 20,
                    percentileLabel: 'Q2 (20-40th)',
                    quintile: 2
                },
                {
                    label: '$62k - $95k',
                    min: quintiles.q3.min,
                    max: quintiles.q3.max,
                    percentage: 20,
                    percentileLabel: 'Q3 (40-60th)',
                    quintile: 3
                },
                {
                    label: '$95k - $142k',
                    min: quintiles.q4.min,
                    max: quintiles.q4.max,
                    percentage: 20,
                    percentileLabel: 'Q4 (60-80th)',
                    quintile: 4
                },
                {
                    label: '$142k+',
                    min: quintiles.q5.min,
                    max: quintiles.q5.max,
                    percentage: 20,
                    percentileLabel: 'Q5 (80-100th)',
                    quintile: 5
                }
            ];

            return brackets;
        }

        async function calculateHousehold() {
            const income = parseFloat(document.getElementById('household-income').value);

            if (isNaN(income) || income < 0) {
                alert(i18next.t('error_invalid_income'));
                return;
            }

            try {
                // Call the backend API for household percentile
                const response = await fetch(`http://localhost:3001/api/income/household-percentile?income=${income}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch data from API');
                }

                const data = await response.json();

                // Generate message using API data with translations
                let message = `<p><strong>${i18next.t('household_result_message_main', {
                    percentile: data.percentile.toFixed(1)
                })}</strong></p>`;

                const diff = data.median.difference;
                const percentDiff = Math.abs(data.median.percentDifference);

                if (diff > 0) {
                    message += `<p>${i18next.t('household_result_message_more', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else if (diff < 0) {
                    message += `<p>${i18next.t('household_result_message_less', {
                        diff: Math.abs(diff).toLocaleString(),
                        percentDiff: percentDiff.toFixed(1),
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                } else {
                    message += `<p>${i18next.t('household_result_message_exact', {
                        median: data.median.value.toLocaleString()
                    })}</p>`;
                }

                message += `<p>${i18next.t('household_result_message_bracket', { bracket: data.bracket })}</p>`;

                document.getElementById('message').innerHTML = message;

                // Update URL with parameters for sharing
                const url = new URL(window.location.href);
                url.searchParams.set('household-income', income);
                url.searchParams.delete('income');
                url.searchParams.delete('age');
                window.history.pushState({}, '', url);

                // Fetch household distribution data for the chart
                const distResponse = await fetch(`http://localhost:3001/api/income/household-distribution`);
                const distData = await distResponse.json();

                // Show results and message box
                document.getElementById('message').style.display = 'block';
                document.getElementById('results').classList.add('show');

                // Update legend with quintile data
                updateHouseholdLegend(distData);

                // Create chart with quintile data
                createHouseholdChart(income, distData.quintiles);

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error:', error);
                alert(i18next.t('error_api_connection'));
            }
        }

        function updateHouseholdLegend(householdData) {
            const legendGrid = document.getElementById('legendGrid');

            const quintileLabels = [
                { key: 'quintile_q1', min: householdData.quintiles.q1.min, max: householdData.quintiles.q1.max },
                { key: 'quintile_q2', min: householdData.quintiles.q2.min, max: householdData.quintiles.q2.max },
                { key: 'quintile_q3', min: householdData.quintiles.q3.min, max: householdData.quintiles.q3.max },
                { key: 'quintile_q4', min: householdData.quintiles.q4.min, max: householdData.quintiles.q4.max },
                { key: 'quintile_q5', min: householdData.quintiles.q5.min, max: householdData.quintiles.q5.max }
            ];

            legendGrid.innerHTML = quintileLabels.map(item => `
                <div class="legend-item">
                    <div class="legend-percentile">${i18next.t(item.key)}</div>
                    <div class="legend-income">$${item.min.toLocaleString()} - $${item.max.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function createHouseholdChart(userIncome, quintiles) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const brackets = generateHouseholdDistributionData(quintiles);

            // Find which quintile the user falls into
            let userQuintileIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (userIncome >= brackets[i].min && userIncome <= brackets[i].max) {
                    userQuintileIndex = i;
                    break;
                }
            }
            if (userQuintileIndex === -1 && userIncome >= brackets[brackets.length - 1].max) {
                userQuintileIndex = brackets.length - 1;
            }

            // Create colors - same style as individual chart
            const backgroundColors = brackets.map((bracket, index) => {
                if (index < userQuintileIndex) {
                    return 'rgba(180, 180, 180, 0.6)'; // Dark grey for below user
                } else if (index === userQuintileIndex) {
                    return 'rgba(213, 43, 30, 0.8)'; // Red for user's quintile
                } else {
                    return 'rgba(220, 220, 220, 0.5)'; // Light grey for above user
                }
            });

            const borderColors = brackets.map((bracket, index) => {
                if (index < userQuintileIndex) {
                    return 'rgba(140, 140, 140, 1)';
                } else if (index === userQuintileIndex) {
                    return 'rgba(213, 43, 30, 1)';
                } else {
                    return 'rgba(180, 180, 180, 0.8)';
                }
            });

            const percentileAnnotations = {};

            // Add user income line
            function getXPositionForIncome(income) {
                let bracketIndex = -1;
                for (let i = 0; i < brackets.length; i++) {
                    if (income >= brackets[i].min && income <= brackets[i].max) {
                        bracketIndex = i;
                        break;
                    }
                }
                if (bracketIndex === -1 && income >= brackets[brackets.length - 1].max) {
                    bracketIndex = brackets.length - 1;
                }

                if (bracketIndex === -1) return 0;

                const bracket = brackets[bracketIndex];
                const range = bracket.max - bracket.min;
                const positionInBracket = range > 0 ? (income - bracket.min) / range : 0.5;

                const barWidth = 0.8;
                const offset = (positionInBracket - 0.5) * barWidth;

                return bracketIndex + offset;
            }

            const userXPosition = getXPositionForIncome(userIncome);
            percentileAnnotations.userIncomeLine = {
                type: 'line',
                xMin: userXPosition,
                xMax: userXPosition,
                borderColor: 'rgba(213, 43, 30, 0.9)',
                borderWidth: 4,
                label: {
                    display: true,
                    content: `${i18next.t('chart_you_label')}: $${userIncome.toLocaleString()}`,
                    position: 'start',
                    backgroundColor: 'rgba(213, 43, 30, 0.9)',
                    color: 'white',
                    font: {
                        size: 11,
                        weight: 'bold'
                    },
                    padding: 6,
                    yAdjust: 10
                }
            };

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brackets.map(b => b.label),
                    datasets: [{
                        label: 'Percentage of Households',
                        data: brackets.map(b => b.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bracket = brackets[context.dataIndex];
                                    return [
                                        `${context.parsed.y}% of households`,
                                        `Range: ${bracket.percentileLabel}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: percentileAnnotations
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                const bracket = brackets[context.dataIndex];
                                return `Q${bracket.quintile}`;
                            },
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            title: {
                                display: true,
                                text: i18next.t('chart_y_axis')
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: i18next.t('chart_x_axis')
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Load values from URL parameters on page load
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const income = urlParams.get('income');
            const age = urlParams.get('age');

            if (income && age) {
                document.getElementById('income').value = income;
                document.getElementById('age').value = age;
                // Automatically calculate if both parameters are present
                calculatePosition();
            }
        }

        // Allow Enter key to submit from either input
        document.getElementById('income').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculatePosition();
            }
        });

        document.getElementById('age').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculatePosition();
            }
        });

        // Load from URL on page load
        loadFromURL();
    </script>
</body>
</html>
