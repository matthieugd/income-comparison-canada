<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Comparison - Canada</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f3f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .input-field label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #d52b1e;
        }
        
        button {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            background: #d52b1e;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(213, 43, 30, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .legend-percentile {
            font-weight: 600;
            color: #d52b1e;
            font-size: 0.95em;
        }
        
        .legend-income {
            color: #666;
            font-size: 0.9em;
        }
        
        .comparison-message {
            background: #ffeaea;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .comparison-message p {
            color: #8b1a10;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .comparison-message p:last-child {
            margin-bottom: 0;
        }
        
        .explanation-box {
            background: #f8f9fa;
            border-left: 4px solid #d52b1e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .explanation-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .explanation-box p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .explanation-box p:last-child {
            margin-bottom: 0;
        }
        
        .faq-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e0e0e0;
        }
        
        .faq-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .faq-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d52b1e;
        }
        
        .faq-question {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
            margin-bottom: 10px;
        }
        
        .faq-answer {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 0.85em;
                margin-bottom: 20px;
            }
            
            .input-section {
                padding: 20px;
            }
            
            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .input-field {
                width: 100%;
            }
            
            .input-field label {
                font-size: 0.9em;
            }
            
            input {
                padding: 12px 15px;
                font-size: 1em;
                width: 100%;
            }
            
            button {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .comparison-message {
                padding: 15px;
                font-size: 0.95em;
            }
            
            .comparison-message p {
                font-size: 0.95em;
            }
            
            .chart-container {
                height: 300px;
                padding: 15px;
            }
            
            .legend {
                padding: 15px;
            }
            
            .legend-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .legend-percentile {
                font-size: 0.85em;
            }
            
            .legend-income {
                font-size: 0.8em;
            }
            
            .explanation-box {
                padding: 15px;
            }
            
            .explanation-title {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .explanation-box p {
                font-size: 0.85em;
            }
            
            .faq-section {
                margin-top: 30px;
                padding-top: 30px;
            }
            
            .faq-title {
                font-size: 1.4em;
                margin-bottom: 20px;
            }
            
            .faq-item {
                padding: 15px;
            }
            
            .faq-question {
                font-size: 0.95em;
            }
            
            .faq-answer {
                font-size: 0.85em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .input-section {
                padding: 25px;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üá®üá¶ Compare Your Salary In Canada </h1>
        <p class="subtitle">Compare your income against Canadian income distribution.</p>
        
        <div class="input-section">
            <div class="input-group">
                <div class="input-wrapper">
                    <div class="input-field">
                        <label for="income">Your Annual Wage ($)</label>
                        <input 
                            type="number" 
                            id="income" 
                            placeholder="65000"
                            min="0"
                            step="1000"
                        >
                    </div>
                    <div class="input-field">
                        <label for="age">Your Age</label>
                        <input 
                            type="number" 
                            id="age" 
                            placeholder="30"
                            min="15"
                            max="100"
                            step="1"
                        >
                    </div>
                    <button onclick="calculatePosition()">Compare</button>
                </div>
            </div>
        </div>
        
        <div class="comparison-message" id="message" style="display: none;"></div>
        
        <div class="results" id="results">
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
            
            <div class="legend">
                <div class="legend-title">üìä Income Distribution Percentiles</div>
                <div class="legend-grid" id="legendGrid"></div>
            </div>
            
            <div class="explanation-box">
                <div class="explanation-title">üí° Understanding Percentiles</div>
                <p><strong>What is a percentile?</strong> A percentile tells you what percentage of people earn less than a given amount.</p>
                <p><strong>Example:</strong> The <strong>25th percentile (P25) is $16,900</strong>. This means 25% of Canadians earn less than $16,900, and 75% earn more.</p>
                <p><strong>The median (P50) is $37,358</strong>. This is the middle point where exactly 50% of people earn less and 50% earn more. It's the most common way to describe "typical" income.</p>
            </div>
        </div>
        
        <div class="faq-section">
            <h2 class="faq-title">‚ùì Frequently Asked Questions</h2>

            <div class="faq-item">
                <div class="faq-question">What's the purpose of their website?</div>
                <div class="faq-answer">
                    We often heard talking about the "average salary" in Canada, but averages can be misleading due to high earners skewing the data. This website aims to provide a clearer picture of income distribution using percentiles, allowing individuals to see how their earnings compare to others in Canada based on reliable census data.
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question">Where does this data come from?</div>
                <div class="faq-answer">
                    This data comes from <strong><a href="https://www12.statcan.gc.ca/census-recensement/index-eng.cfm" title="Census wesbite">Statistics Canada's Census of Population 2021</a></strong>, which is the most comprehensive and reliable source for income distribution in Canada. The census surveys millions of Canadians and provides official government statistics on employment income.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">How current is this data?</div>
                <div class="faq-answer">
                    The income data reflects the <strong>2020 calendar year</strong> (collected during the 2021 Census). While this is the most recent comprehensive census data available, please note that income levels and distributions may have changed since 2020 due to inflation, economic growth, and other factors. The website will be updated when the next census data will be available in 2026-2027.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">Why not use the annual household income survey instead?</div>
                <div class="faq-answer">
                    While Statistics Canada does publish annual household income data (such as Table 36-10-0587), these surveys measure <strong>household-level income</strong> rather than individual earnings. They also use broader economic concepts like "compensation" that include employer benefits and contributions, which don't match what people think of as their "salary." The Census provides <strong>individual wage and salaries</strong> data with detailed percentiles, making it much better for personal comparisons. The trade-off is that Census data is only updated every 5 years, while household surveys are annual. In a future version of this website we will offer to compare the household income data as well.
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question">What does "wage" include?</div>
                <div class="faq-answer">
                    Gross wages and salaries before deductions for such items as income taxes, pension plan contributions and employment insurance premiums during the reference period. <a href="https://www12.statcan.gc.ca/census-recensement/2021/ref/dict/az/definition-eng.cfm?ID=pop128" title="Statistics Canada definition">Source</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        
        function generateDistributionData(percentiles) {
            // Create income brackets with the number of people in each bracket
            // Based on percentile data, we can calculate approximate distributions
            const p10 = percentiles.p10;
            const p25 = percentiles.p25;
            const p50 = percentiles.p50;
            const p75 = percentiles.p75;
            const p90 = percentiles.p90;
            const p95 = percentiles.p95;
            const p99 = percentiles.p99;

            const brackets = [
                { min: 0, max: p10, midpoint: p10/2, percentage: 10, label: `$0-$${Math.round(p10/1000)}K`, percentileLabel: '10%' },
                { min: p10, max: p25, midpoint: (p10+p25)/2, percentage: 15, label: `$${Math.round(p10/1000)}K-$${Math.round(p25/1000)}K`, percentileLabel: '25%' },
                { min: p25, max: p50, midpoint: (p25+p50)/2, percentage: 25, label: `$${Math.round(p25/1000)}K-$${Math.round(p50/1000)}K`, percentileLabel: '50%' },
                { min: p50, max: p75, midpoint: (p50+p75)/2, percentage: 25, label: `$${Math.round(p50/1000)}K-$${Math.round(p75/1000)}K`, percentileLabel: '75%' },
                { min: p75, max: p90, midpoint: (p75+p90)/2, percentage: 15, label: `$${Math.round(p75/1000)}K-$${Math.round(p90/1000)}K`, percentileLabel: '90%' },
                { min: p90, max: p95, midpoint: (p90+p95)/2, percentage: 5, label: `$${Math.round(p90/1000)}K-$${Math.round(p95/1000)}K`, percentileLabel: '95%' },
                { min: p95, max: p99, midpoint: (p95+p99)/2, percentage: 4, label: `$${Math.round(p95/1000)}K-$${Math.round(p99/1000)}K`, percentileLabel: '99%' },
                { min: p99, max: p99 * 1.5, midpoint: p99 * 1.25, percentage: 1, label: `$${Math.round(p99/1000)}K+`, percentileLabel: '100%' }
            ];

            return brackets;
        }
        
        function createChart(userIncome, percentiles) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const brackets = generateDistributionData(percentiles);

            // Find which bracket the user falls into
            let userBracketIndex = -1;
            for (let i = 0; i < brackets.length; i++) {
                if (userIncome >= brackets[i].min && userIncome < brackets[i].max) {
                    userBracketIndex = i;
                    break;
                }
            }
            if (userBracketIndex === -1 && userIncome >= brackets[brackets.length - 1].max) {
                userBracketIndex = brackets.length - 1;
            }
            
            // Create colors - highlight brackets below user's income
            const backgroundColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(180, 180, 180, 0.6)'; // Grey for below user
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 0.8)'; // Red for user's bracket
                } else {
                    return 'rgba(220, 220, 220, 0.5)'; // Light grey for above user
                }
            });

            const borderColors = brackets.map((bracket, index) => {
                if (index < userBracketIndex) {
                    return 'rgba(140, 140, 140, 1)';
                } else if (index === userBracketIndex) {
                    return 'rgba(213, 43, 30, 1)';
                } else {
                    return 'rgba(180, 180, 180, 0.8)';
                }
            });
            
            // Create percentile markers
            const percentileAnnotations = {};
            
            // For bar charts, x positions are categorical (0, 1, 2, 3, etc. for each bar)
            // We need to calculate which bar and position within that bar
            function getXPositionForIncome(income) {
                // Find which bracket the income falls into
                let bracketIndex = -1;
                for (let i = 0; i < brackets.length; i++) {
                    if (income >= brackets[i].min && income <= brackets[i].max) {
                        bracketIndex = i;
                        break;
                    }
                }
                if (bracketIndex === -1 && income >= brackets[brackets.length - 1].max) {
                    bracketIndex = brackets.length - 1;
                }
                
                if (bracketIndex === -1) return 0;
                
                // Calculate position within the bracket (0 to 1)
                const bracket = brackets[bracketIndex];
                const range = bracket.max - bracket.min;
                const positionInBracket = range > 0 ? (income - bracket.min) / range : 0.5;
                
                // For bar charts, bars are centered at integer positions (0, 1, 2, etc.)
                // Each bar has width of ~0.8, so we offset by -0.4 to +0.4 from center
                const barWidth = 0.8;
                const offset = (positionInBracket - 0.5) * barWidth;
                
                return bracketIndex + offset;
            }
            
            // Add user income line
            const userXPosition = getXPositionForIncome(userIncome);
            percentileAnnotations.userIncomeLine = {
                type: 'line',
                xMin: userXPosition,
                xMax: userXPosition,
                borderColor: 'rgba(213, 43, 30, 0.9)',
                borderWidth: 4,
                label: {
                    display: true,
                    content: `YOU: $${userIncome.toLocaleString()}`,
                    position: 'start',
                    backgroundColor: 'rgba(213, 43, 30, 0.9)',
                    color: 'white',
                    font: {
                        size: 11,
                        weight: 'bold'
                    },
                    padding: 6,
                    yAdjust: 10
                }
            };
            
            const percentileLabels = [
                { key: 'p10', label: 'P10', value: percentiles.p10 },
                { key: 'p25', label: 'P25', value: percentiles.p25 },
                { key: 'p50', label: 'Median', value: percentiles.p50 },
                { key: 'p75', label: 'P75', value: percentiles.p75 },
                { key: 'p90', label: 'P90', value: percentiles.p90 },
                { key: 'p95', label: 'P95', value: percentiles.p95 },
                { key: 'p99', label: 'P99', value: percentiles.p99 }
            ];
            
            // No longer adding percentile border lines - they're now shown as labels on bars
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brackets.map(b => b.label),
                    datasets: [{
                        label: 'Percentage of Population',
                        data: brackets.map(b => b.percentage),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bracket = brackets[context.dataIndex];
                                    return [
                                        `${context.parsed.y}% of Canadians`,
                                        `Percentile range: ${bracket.percentileLabel}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: percentileAnnotations
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                return brackets[context.dataIndex].percentileLabel;
                            },
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            padding: 4
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Income Range',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Percentage of Population (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            max: 30,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function updateLegend(percentiles) {
            const legendGrid = document.getElementById('legendGrid');
            const percentileLabels = [
                { label: '10th Percentile (P10)', value: percentiles.p10 },
                { label: '25th Percentile (P25)', value: percentiles.p25 },
                { label: '50th Percentile (Median)', value: percentiles.p50 },
                { label: '75th Percentile (P75)', value: percentiles.p75 },
                { label: '90th Percentile (P90)', value: percentiles.p90 },
                { label: '95th Percentile (P95)', value: percentiles.p95 },
                { label: '99th Percentile (P99)', value: percentiles.p99 }
            ];

            legendGrid.innerHTML = percentileLabels.map(item => `
                <div class="legend-item">
                    <div class="legend-percentile">${item.label}</div>
                    <div class="legend-income">$${item.value.toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        async function calculatePosition() {
            const income = parseFloat(document.getElementById('income').value);
            const age = parseInt(document.getElementById('age').value);

            if (isNaN(income) || income < 0) {
                alert('Please enter a valid income amount');
                return;
            }

            if (isNaN(age) || age < 15 || age > 100) {
                alert('Please enter a valid age (15-100)');
                return;
            }

            try {
                // Call the backend API
                const response = await fetch(`http://localhost:3001/api/income/percentile?income=${income}&age=${age}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch data from API');
                }

                const data = await response.json();

                // Generate message using API data
                let message = `<p><strong>At age ${age}, you earn more than ${data.percentile.toFixed(1)}% of Canadians with employment income in your age group (${data.ageGroup}).</strong></p>`;

                const diff = data.median.difference;
                const percentDiff = Math.abs(data.median.percentDifference);

                if (diff > 0) {
                    message += `<p>You earn $${Math.abs(diff).toLocaleString()} (${percentDiff.toFixed(1)}%) <strong>more</strong> than the median income for your age group ($${data.median.value.toLocaleString()}).</p>`;
                } else if (diff < 0) {
                    message += `<p>You earn $${Math.abs(diff).toLocaleString()} (${percentDiff.toFixed(1)}%) <strong>less</strong> than the median income for your age group ($${data.median.value.toLocaleString()}).</p>`;
                } else {
                    message += `<p>You earn exactly the median income for your age group ($${data.median.value.toLocaleString()}).</p>`;
                }

                message += `<p>Income bracket: <strong>${data.bracket}</strong></p>`;

                document.getElementById('message').innerHTML = message;

                // Update URL with parameters for sharing
                const url = new URL(window.location.href);
                url.searchParams.set('income', income);
                url.searchParams.set('age', age);
                window.history.pushState({}, '', url);

                // Fetch distribution data for the chart
                const distResponse = await fetch(`http://localhost:3001/api/income/distribution?age=${age}`);
                const distData = await distResponse.json();

                // Show results and message box
                document.getElementById('message').style.display = 'block';
                document.getElementById('results').classList.add('show');
                updateLegend(distData.percentiles);
                createChart(income, distData.percentiles);

                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Error:', error);
                alert('Error connecting to the backend API. Please make sure the server is running on port 3001.');
            }
        }
        
        // Load values from URL parameters on page load
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const income = urlParams.get('income');
            const age = urlParams.get('age');

            if (income && age) {
                document.getElementById('income').value = income;
                document.getElementById('age').value = age;
                // Automatically calculate if both parameters are present
                calculatePosition();
            }
        }

        // Allow Enter key to submit from either input
        document.getElementById('income').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculatePosition();
            }
        });

        document.getElementById('age').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculatePosition();
            }
        });

        // Load from URL on page load
        loadFromURL();
    </script>
</body>
</html>
